---
- name: Delete kube-router config from /etc/cni/net.d/
  become: yes
  file:
    path: /etc/cni/net.d/10-kuberouter.conflist
    state: absent

# We do need a list of all namespaces to restart everything and
# additionally this task works as indicator if we are able to
# interact with the k8s API
- name: Gather all namespaces
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  k8s_info:
    kind: Namespace
  register: gather_namespaces
  ignore_errors: yes

- name: Cleanup cluster from kube-router
  become: yes
  run_once: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: not gather_namespaces.failed
  block:
    - name: Ensure all kube-router resources are absent
      k8s:
        definition: "{{ lookup('template', 'kube-router_resources.yaml.j2') }}"
        apply: yes
        state: "absent"
        validate:
          fail_on_error: yes
          strict: yes
      register: kube_router_deletion

    - name: Install kube-proxy
      when: kube_router_deletion.changed
      command:
        argv:
          - kubeadm
          - init
          - phase
          - addon
          - kube-proxy

    - name: Restart (almost) everything (╯°□°)╯︵ ┻━┻
      when: kube_router_deletion.changed
      with_nested:
        - "{{ gather_namespaces.resources }}"
        - ["daemonset", "deployment", "statefulset"]
      loop_control:
        label: "Restart every {{ item[1] }} in namespace {{ item[0].metadata.name }}"
      command:
        argv:
          - kubectl
          - rollout
          - restart
          - "{{ item[1] }}"
          - --namespace
          - "{{ item[0].metadata.name }}"
