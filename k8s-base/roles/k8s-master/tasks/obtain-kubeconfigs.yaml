---
- name: Obtain kubeconfigs
  # We do this step on each node, so we have to use node credentials
  environment:
    ANSIBLE_HASHI_VAULT_URL: "{{ lookup('env', 'VAULT_ADDR') }}"
    ANSIBLE_HASHI_VAULT_CA_CERT: "{{ lookup('env', 'VAULT_CACERT') }}"
  vars:
    kubeconfig_api_server_url: "https://{{ networking_fixed_ip }}:{{ hostvars[available_frontend]['k8s_apiserver_frontend_port'] }}"
  block:
  # This is based on the k8s best practices
  # https://kubernetes.io/docs/setup/best-practices/certificates/
  - name: Generate controller-manager kubeconfig
    ansible.builtin.include_tasks: mkkubeconfig.yaml
    vars:
      vault_role_id: "{{ vault_node_role_id }}"
      vault_secret_id: "{{ vault_node_secret_id }}"
      kubeconfig_title: controller-manager
      kubeconfig_destination: /etc/kubernetes/controller-manager.conf
      kubeconfig_issuer: system-masters_controllers
      kubeconfig_user: system:kube-controller-manager
      kubeconfig_notify: Restart kube-controller-manager

  - name: Generate scheduler kubeconfig
    ansible.builtin.include_tasks: mkkubeconfig.yaml
    vars:
      vault_role_id: "{{ vault_node_role_id }}"
      vault_secret_id: "{{ vault_node_secret_id }}"
      kubeconfig_title: scheduler
      kubeconfig_destination: /etc/kubernetes/scheduler.conf
      kubeconfig_issuer: system-masters_controllers
      kubeconfig_user: system:kube-scheduler
      kubeconfig_notify: Restart kube-scheduler

  - name: Generate kubelet kubeconfig
    ansible.builtin.include_tasks: mkkubeconfig.yaml
    vars:
      vault_role_id: "{{ vault_node_role_id }}"
      vault_secret_id: "{{ vault_node_secret_id }}"
      kubeconfig_title: kubelet
      kubeconfig_destination: /etc/kubernetes/kubelet.conf
      kubeconfig_issuer: system-nodes_node
      kubeconfig_user: "system:node:{{ inventory_hostname }}"
      kubeconfig_external: true
      kubeconfig_keypair_path: /var/lib/kubelet/pki/kubelet-client-current.pem
      kubeconfig_notify: Restart only this kubelet

  - name: Generate admin kubeconfig
    ansible.builtin.include_tasks: mkkubeconfig.yaml
    vars:
      vault_role_id: "{{ vault_node_role_id }}"
      vault_secret_id: "{{ vault_node_secret_id }}"
      kubeconfig_title: admin
      kubeconfig_destination: /etc/kubernetes/admin.conf
      kubeconfig_issuer: system-masters_admin
      kubeconfig_user: kubernetes-admin
