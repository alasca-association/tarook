---
- import_tasks: remove_kube-proxy.yaml

- name: Setup kube-router
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s:
    definition: "{{ lookup('template', 'kubeadm-kuberouter.yaml') }}"
    apply: yes
    state: "present"
    validate:
      fail_on_error: yes
      strict: yes
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"

- name: Enumerate all nodes
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes

- name: Wait for kube-router to be up on all nodes
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    namespace: kube-system
    name: kube-router
  register: kube_router_ds
  until: |
    ((kube_router_ds.resources | default(False)) and
     (kube_router_ds.resources[0].status | default(False)) and
     (kube_router_ds.resources[0].status.numberReady == nodes.resources | length) and
     (kube_router_ds.resources[0].status.numberAvailable == nodes.resources | length))
  retries: 60
  delay: 3

- name: Mark networking as configured
  set_fact:
    runtime_k8s_networking_configured: true
