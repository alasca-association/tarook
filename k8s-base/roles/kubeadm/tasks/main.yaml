- name: Install prerequisites
  become: yes
  apt:
    update_cache: yes
    state: present
    name:
      - curl
      - apt-transport-https
      - gnupg
  when: ansible_pkg_mgr == 'apt'

- name: Add Google's K8s repository (apt)
  become: yes
  block:

  - name: Add Key of Google's K8s repository
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

  - name: Add Google's K8s repository to sources.list
    copy:
      dest: /etc/apt/sources.list.d/kubernetes.list
      content: |
        {{ _auto_generated_preamble }}
        deb https://apt.kubernetes.io/ kubernetes-xenial main
      owner: root
      group: root
      mode: 0640

  - name: Install kubelet, kubeadm and kubectl
    # Note: check available version with `apt-cache policy <package name>`
    apt:
      update_cache: yes
  when: ansible_pkg_mgr == 'apt'

- name: Add Google's K8s repository (yum/dnf)
  become: yes
  template:
    src: kubernetes.repo
    dest: /etc/yum.repos.d/kubernetes.repo
    owner: root
    group: root
    mode: 0640
  when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'yum'

- name: Install kubelet, kubeadm and kubectl

  block:
  - name: Prepare list of packages to install (apt)
    set_fact:
      packages:
        - "kubelet={{ k8s_version }}-00"
        - "kubeadm={{ k8s_version }}-00"
        - "kubectl={{ k8s_version }}-00"
    when: ansible_pkg_mgr == 'apt'
    notify: Restart kubelet

  - name: Prepare list of packages to install (yum/dnf)
    set_fact:
      packages:
        - "kubelet-{{ k8s_version }}-00"
        - "kubeadm-{{ k8s_version }}-00"
        - "kubectl-{{ k8s_version }}-00"
    when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'yum'
    notify: Restart kubelet

  - name: Install kubelet, kubeadm and kubectl
    # Note: check available version with `apt-cache policy <package name>`
    become: yes
    package:
      state: present
      name: "{{ packages }}"

  - name: Prevent the k8s packages for being updated (apt)
    become: yes
    command: apt-mark hold kubelet kubeadm kubectl
    when: ansible_pkg_mgr == 'apt'

  - name: Prevent the k8s packages for being updated (dnf)
    become: yes

    block:
    - name: Install dnf versionlock
      dnf:
        name:
        - 'dnf-command(versionlock)'
        state: latest

    - name: Add a version lock
      command:
      args:
        argv:
        - dnf
        - versionlock
        - kubelet
        - kubeadm
        - kubectl

    when: ansible_pkg_mgr == 'dnf'

# kubelet should be restarted immediately
- name: Force restart of kubelet at this point
  meta: flush_handlers
