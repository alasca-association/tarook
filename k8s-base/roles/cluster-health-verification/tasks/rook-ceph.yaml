---
- name: Wait until Ceph is healthy
  block:
  - name: Set retry count
    ansible.builtin.set_fact:
      retry_count: "{{ 0 if retry_count is undefined else (retry_count | int) + 1 }}"

  - name: Include Rook/Ceph cluster health verification
    ansible.builtin.include_role:
      name: rook_v1
      tasks_from: cluster_health_verification

  rescue:
  - name: Fail if the cluster did not converge
    ansible.builtin.fail:
      msg: "Rook components did not converge after the upgrade ({{ retry_count }} retries)"
    when: (retry_count | int) == 360

  - name: Pause for 10 seconds, give the cluster more time to converge
    ansible.builtin.pause:
      seconds: 10

  # Recheck if retry_count limit has not been reached, yet
  - ansible.builtin.include_tasks: rook-ceph.yaml

- name: Print completion message
  ansible.builtin.debug:
    msg: "The Ceph cluster looks happy!"
...
