- name: Read role-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/role-id
  register: cat_role_id
  changed_when: false

- name: Read secret-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/secret-id
  register: cat_secret_id
  changed_when: false

- name: Update calico-node certificate
  include_tasks: get_cert_in_k8s.yaml
  vars:
    vault_role_id: "{{ cat_role_id.stdout }}"
    vault_secret_id: "{{ cat_secret_id.stdout }}"
    get_cert_k8s_title: calico-node
    get_cert_k8s_vault_path: "{{ vault_path_prefix }}/{{ vault_cluster_name }}/calico-pki/issue/node"
    get_cert_k8s_vault_data:
      common_name: calico-node
      ttl: 8784h
    get_cert_k8s_secret_name: calico-node-certs
    get_cert_k8s_namespace: kube-system
    get_cert_k8s_filename: calico-node

- name: Apply calico/node resources
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
  - name: Create ServiceAccount for calico/node, configure RBAC, ClusterRole, ClusterRoleBinding
    k8s:
      definition: "{{ lookup('file', item) }}"
      apply: yes
      state: "present"
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - calico-node-serviceaccount.yaml

  # Install calico/node Daemon-Set
  # Felix: - Calico per-node daemon
  # BIRD: - Distribution of routing information via the BGP protocol
  # confd: - watches Calico datastore for config changes and updates BIRDs config files
  - name: Deploy Calico node DaemonSet
    k8s:
      apply: yes
      definition: "{{ lookup('template', item) }}"
      validate:
        fail_on_error: yes
        strict: yes
      wait: yes
    with_items:
    - calico-node-daemonset.yaml.j2

- name: Restart calico/node Pods on certificate renewal
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: get_cert is changed
  block:
  - name: Restart calico/node Pods
    command:
      argv:
        - kubectl
        - rollout
        - restart
        - ds
        - calico-node
        - -n
        - kube-system

  - name: Wait for Rollout Restart of calico/node Pods to finish
    command:
      argv:
        - kubectl
        - rollout
        - status
        - ds
        - calico-node
        - -n
        - kube-system
