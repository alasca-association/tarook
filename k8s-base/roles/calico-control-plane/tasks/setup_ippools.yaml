# This task uses calicoctl. This is currently necessary to configure
# Calico specific resources as the Calico CRDs are not designed to
# be used directly by kubectl. Please refer to the following issue:
# https://github.com/projectcalico/calico/issues/2923
---
- name: Apply IPPool(s)
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    DATASTORE_TYPE: kubernetes
  vars:
    calicoctl_command_blocks:
      - "/usr/local/bin/calicoctl"
      - "apply"
      # During Kubernetes upgrades, version mismatches are expected. Otherwise they are not.
      - "{{ (next_k8s_version | default(False) or _allow_disruption) | ternary('--allow-version-mismatch', '') }}"
      - "--filename=-"
  ansible.builtin.command:
    argv: "{{ calicoctl_command_blocks | select }}"
    stdin: '{{ lookup("template", "ippools.yaml.j2") }}'
  register: ippool_creation
  changed_when: "'Successfully applied' in ippool_creation.stdout and 'IPPool' in ippool_creation.stdout"
...
