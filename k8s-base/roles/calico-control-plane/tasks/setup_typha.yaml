---
- name: Get calico versions folder
  include_tasks: get_calico_versions_folder.yaml

- name: Update typha certificate
  ansible.builtin.include_tasks: get_cert_in_k8s.yaml
  vars:
    vault_role_id: "{{ vault_node_role_id }}"
    vault_secret_id: "{{ vault_node_secret_id }}"
    get_cert_k8s_title: typha
    get_cert_k8s_vault_path: "{{ vault_path_prefix }}/{{ vault_cluster_name }}/calico-pki/issuer/{{ k8s_issuer | default('default') }}/issue/typha"
    get_cert_k8s_vault_data:
      common_name: calico-typha
      ttl: 8784h
    get_cert_k8s_secret_name: calico-typha-certs
    get_cert_k8s_namespace: kube-system
    get_cert_k8s_filename: typha

- name: Apply Typha resources
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
  - name: Create ServiceAccount for calico-typha, configure RBAC, ClusterRole, ClusterRoleBinding
    kubernetes.core.k8s:
      definition: "{{ lookup('file', item) }}"
      apply: true
      state: "present"
      validate:
        fail_on_error: true
        strict: true
    with_items:
    - "{{ calico_versions_folder }}/typha-serviceaccount.yaml"
    # Retry this task on failures
    register: k8s_apply
    until: k8s_apply is not failed
    retries: "{{ k8s_error_retries }}"
    delay: "{{ k8s_error_delay }}"

  - name: Deploy Typha Deployment
    kubernetes.core.k8s:
      definition: "{{ lookup('template', item) }}"
      apply: true
      validate:
        fail_on_error: true
        strict: true
    with_items:
    - "{{ calico_versions_folder }}/typha-deployment.yaml.j2"
    # Retry this task on failures
    register: k8s_apply
    until: k8s_apply is not failed
    retries: "{{ k8s_error_retries }}"
    delay: "{{ k8s_error_delay }}"

  - name: Deploy Typha service
    kubernetes.core.k8s:
      definition: "{{ lookup('file', item) }}"
      apply: true
      validate:
        fail_on_error: true
        strict: true
      wait: true
    with_items:
    - typha-service.yaml
    # Retry this task on failures
    register: k8s_apply
    until: k8s_apply is not failed
    retries: "{{ k8s_error_retries }}"
    delay: "{{ k8s_error_delay }}"

- name: Restart Typha Pods on certificate_renewal  # noqa no-handler
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: get_cert is changed
  block:
  - name: Restart Typha Pods  # noqa no-changed-when
    ansible.builtin.command:
      argv:
      - kubectl
      - rollout
      - restart
      - deployment
      - calico-typha
      - -n
      - kube-system

  - name: Wait for Rollout Restart of Typha Pods to finish  # noqa no-changed-when
    ansible.builtin.command:
      argv:
      - kubectl
      - rollout
      - status
      - deployment
      - calico-typha
      - -n
      - kube-system

# TODO: Validate that Typha is using TLS?
# https://docs.projectcalico.org/getting-started/kubernetes/hardway/install-typha#install-service
...
