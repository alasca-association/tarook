- name: Read role-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/role-id
  register: cat_role_id
  changed_when: false

- name: Read secret-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/secret-id
  register: cat_secret_id
  changed_when: false

- name: Update typha certificate
  include_tasks: get_cert_in_k8s.yaml
  vars:
    vault_role_id: "{{ cat_role_id.stdout }}"
    vault_secret_id: "{{ cat_secret_id.stdout }}"
    get_cert_k8s_title: typha
    get_cert_k8s_vault_path: "{{ vault_path_prefix }}/{{ vault_cluster_name }}/calico-pki/issue/typha"
    get_cert_k8s_vault_data:
      common_name: calico-typha
      ttl: 8784h
    get_cert_k8s_secret_name: calico-typha-certs
    get_cert_k8s_namespace: kube-system
    get_cert_k8s_filename: typha

- name: Apply Typha resources
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
  - name: Create ServiceAccount for calico-typha, configure RBAC, ClusterRole, ClusterRoleBinding
    k8s:
      definition: "{{ lookup('file', item) }}"
      apply: yes
      state: "present"
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - typha-serviceaccount.yaml

  - name: Deploy Typha Deployment
    k8s:
      definition: "{{ lookup('template', item) }}"
      apply: yes
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - typha-deployment.yaml.j2

  - name: Deploy Typha service
    k8s:
      definition: "{{ lookup('file', item) }}"
      apply: yes
      validate:
        fail_on_error: yes
        strict: yes
      wait: yes
    with_items:
    - typha-service.yaml

- name: Restart Typha Pods on certificate_renewal
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: get_cert is changed
  block:
  - name: Restart Typha Pods
    command:
      argv:
        - kubectl
        - rollout
        - restart
        - deployment
        - calico-typha
        - -n
        - kube-system

  - name: Wait for Rollout Restart of Typha Pods to finish
    command:
      argv:
        - kubectl
        - rollout
        - status
        - deployment
        - calico-typha
        - -n
        - kube-system

# TODO: Validate that Typha is using TLS?
# https://docs.projectcalico.org/getting-started/kubernetes/hardway/install-typha#install-service
