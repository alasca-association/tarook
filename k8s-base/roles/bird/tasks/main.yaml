---
- name: install bird
  become: true
  ansible.builtin.apt:
    name: bird
    state: present
  register: task_result
  until: task_result is not failed
  retries: "{{ network_error_retries }}"
  delay: "{{ network_error_delay }}"
  tags:
  - bird

- name: configure bird
  become: true
  ansible.builtin.template:
    src: bird.conf
    dest: /etc/bird/bird.conf
    owner: bird
    group: bird
    mode: 0o640
  notify: restart bird
  tags:
  - bird

- name: drop-in directory for bird config
  become: true
  ansible.builtin.file:
    state: directory
    path: /etc/bird.d/
    owner: root
    group: bird
    mode: "u=rwx,g=rx,o-rwx"
  tags:
  - bird

- name: disable bird6
  become: true
  ansible.builtin.service:
    name: bird6
    enabled: false
    state: stopped
  when: not dualstack_support
  tags:
  - bird

- name: Initialize config of bird6 for IPv6 support
  become: true
  when: dualstack_support
  tags:
  - bird6
  block:
  - name: Create config for bird6 in /etc/bird/
    ansible.builtin.template:
      src: bird6.conf
      dest: /etc/bird/bird6.conf
      owner: bird
      group: bird
      mode: 0640
    notify: restart bird

  - name: Create drop-in directory for bird6 configs
    ansible.builtin.file:
      state: directory
      path: /etc/birdv6.d/
      owner: root
      group: bird
      mode: "u=rwx,g=rx,o-rwx"

  - name: enable bird6
    ansible.builtin.service:
      name: bird6
      enabled: true
      state: started
...
