# A GPU has been detected
---
- name: Install GPU drivers
  become: true
  when:
    - k8s_is_gpu_cluster | default(False)
    - has_gpu
    - _allow_disruption or install_status == 'k8s_not_installed'
    - ansible_facts['pkg_mgr'] == "apt"
  block:
    - name: Install deps for the nvidia drivers
      ansible.builtin.apt:
        state: present
        name:
          - "linux-headers-{{ ansible_kernel }}"
      register: task_result
      until: task_result is not failed
      retries: "{{ network_error_retries }}"
      delay: "{{ network_error_delay }}"

    - name: Add key of nvidia's cuda repo
      ansible.builtin.apt_key:
        # presented key is the same for ubuntu1604, ubuntu1804 and ubuntu2004
        url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub
        state: present
      register: task_result
      until: task_result is not failed
      retries: "{{ network_error_retries }}"
      delay: "{{ network_error_delay }}"

    - name: Add repository
      ansible.builtin.apt_repository:
        repo: deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/ /
        state: present
        update_cache: true
      register: task_result
      until: task_result is not failed
      retries: "{{ network_error_retries }}"
      delay: "{{ network_error_delay }}"

    - name: Install driver
      ansible.builtin.apt:
        update_cache: false
        install_recommends: false
        autoremove: true
        name:
          - nvidia-headless-450
          - nvidia-utils-450
      register: installed_driver
      until: installed_driver is not failed
      retries: "{{ network_error_retries }}"
      delay: "{{ network_error_delay }}"

    - name: Blacklist nouveau
      # The installation script lies! It says: """
      # update-initramfs: deferring update (trigger activated)
      # A modprobe blacklist file has been created at /etc/modprobe.d to prevent Nouveau
      # from loading. This can be reverted by deleting the following file:
      # /etc/modprobe.d/nvidia-graphics-drivers.conf"""
      # And guess what? That configuration file doesn't exist!
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist_nouveau.conf
        content: |
          {{ _auto_generated_preamble }}
          blacklist nouveau
          options nouveau modeset=0
        mode: 0755
        owner: root
        group: root
      register: blacklisted_nouveau

    - name: Update initramfs
      ansible.builtin.command: "update-initramfs -k {{ ansible_kernel }} -uv"
      when: blacklisted_nouveau.changed or installed_driver.changed
      register: ramfs

    - name: Reboot the node
      when: ramfs.changed
      ansible.builtin.reboot:

    - name: Basic sanity check with nvidia-smi
      # nvidia-smi -L lists all detected cards.
      # I installed the toolchain on a host with any nvidia cards and the rc was != 0.
      # It's therefore safe to assume that if the installation somehow failed, then this task would fail too.
      changed_when: false
      ansible.builtin.command: nvidia-smi -L
...
