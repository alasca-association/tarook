# Special steps when updating Kubernetes to v1.22.x
---
# Previously, it was a StatefulSet. Now it is a Deployment.
# Prevent interference by removing the StatefulSet prior to
# creating the Deployment.
- name: Delete old Cinder CSI Controllerplugin
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s:
    state: absent
    apply: true
    definition: "{{ lookup('template', 'k8s-v1.21/cinder-csi-plugin/cinder-csi-controllerplugin.yaml.j2') }}"
    validate:
      fail_on_error: true
      strict: true
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"
...
