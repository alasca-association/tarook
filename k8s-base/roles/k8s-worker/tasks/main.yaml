---
- name: Gather necessary cluster join information
  when: install_status == 'k8s_not_installed'
  block:
  - name: Get certificate information
    become: no
    delegate_to: localhost
    community.crypto.x509_certificate_info:
      path: "{{ etc_dir }}/ca.crt"
    register: ca_cert

  - name: Join the k8s cluster steps
    become: yes
    block:
    - name: Create kubeadm-join-config.yaml
      vars:
        kubeadm_join_token: "{{ lookup('file', '{{ etc_dir }}/kubeadm_token') }}"
      ansible.builtin.template:
        src: kubeadm-join-config.yaml.j2
        dest: /tmp/kubeadm-join-config.yaml
        owner: root
        group: root
        mode: 0640

    - name: Join the k8s cluster as another worker
      # XXX: ansible command module does not support setting the umask
      ansible.builtin.shell: "sleep {{ 10 | random }} && umask 077 && kubeadm join --node-name {{ inventory_hostname | quote }} --config=/tmp/kubeadm-join-config.yaml"
      async: 300
      poll: 5

    - name: Remove kubeadm-join-config.yaml
      ansible.builtin.file:
        path: /tmp/kubeadm-join-config.yaml
        state: absent

    # Workaround because it is currently not possible
    # to pass a kubelet config file for kubeadm join
    # https://stackoverflow.com/questions/60378117/limit-the-number-of-pods-per-node
    - name: Configure kubelet
      ansible.builtin.include_role:
        name: kubelet-configuration
      vars:
        _init_cluster: True # needs to be passed so that kubelet is configured & restarted
...
