---
# We don't want to assert mode here
- name: Create parent directories for PKI directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: u=rwx,go=rx
  loop:
  - /etc/kubernetes
  - /var/lib/kubelet

# The focus of the following two tasks is on fixing the permissions.
- name: Create PKI directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: u=rwx,go-rwx
  loop:
  - /etc/kubernetes/pki
  - /etc/kubernetes/pki/etcd
  - /var/lib/kubelet/pki

- name: Obtain CAs
  include_tasks: obtain-cas.yaml

- name: Obtain kubeconfigs
  include_tasks: obtain-kubeconfigs.yaml

- name: Join the k8s cluster steps
  when: install_status == 'k8s_not_installed'
  become: true
  block:
  - name: Create kubeadm-join-config.yaml
    ansible.builtin.template:
      src: kubeadm-join-config.yaml.j2
      dest: /tmp/kubeadm-join-config.yaml
      owner: root
      group: root
      mode: 0640

  - name: Join the k8s cluster as another worker  # noqa no-changed-when
    # XXX: ansible command module does not support setting the umask
    ansible.builtin.shell: "umask 077 && kubeadm join --config=/tmp/kubeadm-join-config.yaml"

  - name: Remove kubeadm-join-config.yaml
    ansible.builtin.file:
      path: /tmp/kubeadm-join-config.yaml
      state: absent

  # Workaround because it is currently not possible
  # to pass a kubelet config file for kubeadm join
  # https://stackoverflow.com/questions/60378117/limit-the-number-of-pods-per-node
  - name: Configure kubelet
    ansible.builtin.include_role:
      name: kubelet-configuration
    vars:
      _init_cluster: true  # needs to be passed so that kubelet is configured & restarted
...
