---
# This implements https://kubernetes.io/docs/tasks/tls/manual-rotation-of-ca-certificates/

# TODO: check for disruption ?

- name: Obtain CAs
  ansible.builtin.include_role:
    name: k8s-master
    tasks_from: obtain-cas.yaml
  vars:
    ca_rotation: true

- name: Workaround for bug in controller-manager # https://github.com/kubernetes/kubeadm/issues/1350
  become: true
  block:
  - name: Write k8s CA file
    ansible.builtin.copy:
      dest: /etc/kubernetes/pki/ca-new.crt
      owner: root
      group: root
      mode: ugo=r
      content: "{{ k8s_ca_cert }}"

  - name: Point kube-controller-manager to new CA
    ansible.builtin.replace:
      path: /etc/kubernetes/manifests/kube-controller-manager.yaml
      regexp: '^(\s*-\s*--client-ca-file=).*'
      replace: '\1/etc/kubernetes/pki/ca-new.crt' # TODO: or use the old one here?

- name: trigger restart kube-controller-manager
  command: /bin/true
  notify: Restart kube-controller-manager

- name: Flush handlers
  meta: flush_handlers

- name: wait for restart to be done
  # TODO
  ansible.builtin.pause:
    seconds: 5

- name: Restart all managed pods
  when: cm_replace.changed
  include_tasks: restart-all.yaml
  vars:
    resource_type: "{{ item }}"
  loop: ["deployment", "daemonset", "statefulset"]

- name: wait for restart to be done
  # TODO
  ansible.builtin.pause:
    seconds: 5

- name: trigger restart apiserver
  command: /bin/true
  notify: Restart kube-apiserver

- name: Flush handlers
  meta: flush_handlers

- name: wait for restart to be done
  # TODO
  ansible.builtin.pause:
    seconds: 5

- name: trigger restart kube-scheduler
  command: /bin/true
  notify: Restart kube-scheduler

- name: Obtain kubeconfigs
  ansible.builtin.include_role:
    name: k8s-master
    tasks_from: obtain-kubeconfigs.yaml
  vars:
    force_renewal: true
    k8s_issuer: next
    extra_ca: default
...
