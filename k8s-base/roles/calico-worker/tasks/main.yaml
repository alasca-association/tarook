- name: Read role-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/role-id
  register: cat_role_id
  changed_when: false

- name: Read secret-id
  become: yes
  command:
  args:
    argv:
    - cat
    - /etc/vault/secret-id
  register: cat_secret_id
  changed_when: false

- name: Create /etc/cni/net.d/
  become: yes
  file:
    owner: root
    group: root
    mode: u=rw,g=r,o-rwx
    path: /etc/cni/net.d/
    state: directory

- name: Generate calico kubeconfig
  include_role:
    name: k8s-master
    tasks_from: mkkubeconfig
  vars:
    vault_role_id: "{{ cat_role_id.stdout }}"
    vault_secret_id: "{{ cat_secret_id.stdout }}"
    kubeconfig_title: calico
    kubeconfig_destination: /etc/cni/net.d/calico-kubeconfig
    kubeconfig_issuer: calico-cni
    kubeconfig_user: calico-cni
    kubeconfig_api_server_url: "https://{{ networking_fixed_ip }}:{{ k8s_apiserver_frontend_port }}"
