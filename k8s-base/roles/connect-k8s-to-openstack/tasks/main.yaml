---
- name: Preliminaries
  block:
    # Remove me when dropping support for
    # k8s v1.19, v1.20 & v1.21
    - name: Include controller manager patch
      ansible.builtin.include_tasks: patch_controller_manager.yaml
      when:
        - k8s_version_minor is version('1.22', '<')

- name: Create cloud-config secret
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s:
    apply: yes
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      data:
        cloud.conf: "{{ lookup('template', 'os_cloud_config.ini') | b64encode }}"
      metadata:
        name: cloud-config
        namespace: kube-system
    validate:
      fail_on_error: yes
      strict: yes
  notify:
  - restart CCM
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"

- name: Start the OpenStack Cloud Controller manager
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  vars:
    template_folder: "{{ ('k8s-v' + k8s_version_minor + '/') }}"
  block:
    - name: Deploy the CCM and its RBAC
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', template_folder + 'cloud-controller-manager/rbac/' + item) }}"
        validate:
          fail_on_error: yes
          strict: yes
      loop:
        - cloud-controller-manager-roles.yaml.j2
        - cloud-controller-manager-role-bindings.yaml.j2
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Deploy Cloud-Controller-Manger
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', template_folder + 'cloud-controller-manager/openstack-cloud-controller-manager-ds.yaml.j2') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Start the Cinder CSI driver plugin
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', item) }}"
        validate:
          fail_on_error: yes
          strict: yes
      # loop over all template-files in the respective directory
      # the number/names of template-files may differ between versions
      with_fileglob:
      - "templates/{{ template_folder }}cinder-csi-plugin/*.yaml.j2"
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Create cinder storage class (hdd)
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('file', 'cinder/cinder_storage_class.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Create cinder storage class (nvme)
      when: openstack_cinder_nvme
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('file', 'cinder/cinder_nvme_storage_class.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"
...
