---
- name: Populate service facts
  service_facts:

- name: stop systemd time sync
  become: yes
  become_user: root
  service:
    name: systemd-timesyncd
    enabled: no
  when: ansible_facts.services['systemd-timesyncd'] is defined

- name: install chrony
  become: yes
  become_user: root
  package:
    name:
    - chrony
    state: present

- name: Configure chrony (Debian based)
  become: true
  when: ansible_os_family == "Debian"
  block:

    - name: Create custom configuration (Debian)
      template:
        src: chrony.conf.j2
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: 0644
      register: configuration_update_debian

    - name: Restart chrony # noqa no-handler
      when: configuration_update_debian.changed
      systemd:
        name: chrony
        enabled: true
        state: restarted
        daemon_reload: true

- name: Configure chrony (RHEL like)
  become: true
  when: ansible_os_family == "RedHat"
  block:

    - name: Create custom configuration (RHEL like)
      template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        owner: root
        group: root
        mode: 0644
      register: configuration_update_rhel

    - name: Restart chronyd # noqa no-handler
      when: configuration_update_rhel.changed
      systemd:
        name: chronyd
        enabled: true
        state: restarted
        daemon_reload: true

- name: ensure chrony is running
  become: yes
  become_user: root
  service:
    name: chronyd
    state: started
    enabled: yes

- name: disable systemd time sync
  become: yes
  become_user: root
  service:
    name: systemd-timesyncd
    state: stopped
  when: ansible_facts.services['systemd-timesyncd'] is defined
