---
- name: Populate service facts
  service_facts:

- name: stop systemd time sync
  become: yes
  become_user: root
  service:
    name: systemd-timesyncd
    enabled: no
  when: ansible_facts.services['systemd-timesyncd'] is defined

- name: install chrony
  become: yes
  become_user: root
  package:
    name:
    - chrony
    state: present

- name: create custom configuration
  become: yes
  when: custom_chrony_configuration | bool
  template:
    src: chrony.conf.j2 
    dest: /etc/chrony.conf
    owner: root
    group: root
    mode: 0640
  register: configuration_update

- name: Restart chrony # noqa no-handler
  become: yes
  # Only restart if something changed AND we're allowed to do the restart
  when: configuration_update.changed
  systemd:
    enabled: yes
    state: restarted
    daemon_reload: yes
    name: chrony

- name: ensure chrony is running
  become: yes
  become_user: root
  service:
    name: chronyd
    state: started
    enabled: yes

- name: disable systemd time sync
  become: yes
  become_user: root
  service:
    name: systemd-timesyncd
    state: stopped
  when: ansible_facts.services['systemd-timesyncd'] is defined
