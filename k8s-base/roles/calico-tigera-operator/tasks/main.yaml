---
- name: Check if tigera-operator already exists
  delegate_to: localhost
  run_once: true
  block:
    - name: Check if tigera-operator Deployment exists
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Deployment
        name: tigera-operator
        namespace: tigera-operator
      register: tigera_operator_deployment

    - name: Set fact if tigera-operator Deployment exists
      ansible.builtin.set_fact:
        tigera_operator_exists: "{{ tigera_operator_deployment.resources | length >= 1 | bool }}"

- name: Check for migration tasks
  ansible.builtin.include_tasks: migrate.yaml

- name: Install calico as a network driver
  become: true
  become_user: root
  run_once: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
    - name: Create tigera-operator Namespace
      kubernetes.core.k8s:
        name: tigera-operator
        api_version: v1
        kind: Namespace
        state: present
        validate:
          fail_on_error: true
          strict: true

    - name: Download tigera-operator manifest to the cluster
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/projectcalico/calico/{{ tigera_operator_version }}/manifests/tigera-operator.yaml"
        dest: /tmp/tigera-operator.yaml
        mode: '0664'

    - name: Apply tigera-operator manifest to the cluster
      kubernetes.core.k8s:
        state: present
        src: /tmp/tigera-operator.yaml

    - name: Create the Calico Installation Resource
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', calico_installation_resource_file_path) | from_yaml }}"

    - name: Create the Calico APIServer Resource
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', calico_apiserver_resource_file_path) | from_yaml }}"

    - name: Remove calico node DaemonSet
      kubernetes.core.k8s:
        state: absent
        api_version: apps/v1
        kind: DaemonSet
        namespace: kube-system
        name: calico-node

    - name: Remove calico-kube-controllers Deployment
      kubernetes.core.k8s:
        state: absent
        api_version: apps/v1
        kind: Deployment
        namespace: kube-system
        name: calico-kube-controllers

    - name: Remove calico typha Deployment
      kubernetes.core.k8s:
        state: absent
        api_version: apps/v1
        kind: Deployment
        namespace: kube-system
        name: calico-typha

- name: Setup BGP Routing Information Distribution via BIRD
  run_once: true
  ansible.builtin.include_tasks: setup_bgp.yaml
...
