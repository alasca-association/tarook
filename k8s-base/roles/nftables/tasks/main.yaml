- name: Install nftables package
  become: yes
  package:
    state: present
    name:
      - nftables

- name: Remove iptables package
  become: yes
  package:
    state: absent
    name:
      - iptables

- name: Retrieve private subnet
  set_fact:
    priv_ip_cidr: "{{ ip | ipaddr('network/prefix') }}"
  vars:
    ip: "{{ ansible_default_ipv4.address }}/{{ ansible_default_ipv4.netmask }}"

- name: Create drop-in directory for other rules
  become: yes
  file:
    state: directory
    path: /etc/nft.d
    owner: root
    group: root
    mode: "u=rwx,g=rx,o-rwx"

- name: Configure nftables firewall
  become: yes
  template:
    src: "{{ role_path }}/templates/nftables.conf.j2"
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: 0600

- name: Start&enable nftables systemd service
  become: yes
  systemd:
    name: nftables
    state: restarted
    enabled: yes
    masked: false
