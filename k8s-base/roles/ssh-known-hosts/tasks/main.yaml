---
# We're aware that TOFU is not ideal.
# Signing host keys with a SSH CA and the verification of hosts
# via it is already on our road map.

- name: Manage known hosts
  delegate_to: localhost
  become: false
  block:
  - name: Make sure {{ ssh_known_hosts_file }} exists
    run_once: true
    ansible.builtin.file:
      path: "{{ ssh_known_hosts_file }}"
      state: touch
      mode: 0644

  - name: Scan for SSH host keys.
    ansible.builtin.command: "ssh-keyscan {{ ansible_host }}"
    changed_when: false
    register: ssh_keyscan

  - name: Check if {{ inventory_hostname }} is already known
    ansible.builtin.known_hosts:
      name: "{{ ansible_host }}"
      path: "{{ ssh_known_hosts_file }}"
      state: absent
    check_mode: true
    register: ssh_host_present

  - name: Check for key diffs
    ansible.builtin.known_hosts:
      name: "{{ ansible_host }}"
      key: "{{ inventory_hostname }},{{ item }}"
      path: "{{ ssh_known_hosts_file }}"
      state: present
    with_items: "{{ ssh_keyscan.stdout_lines }}"
    register: ssh_host_update
    check_mode: true

  - name: Fail if a already known host changed
    with_items: "{{ ssh_host_update.results }}"
    loop_control:
      label: "{{ item.item }}"
    when:
    - (item.changed | bool) and (ssh_host_present.changed | bool)
    - not allow_host_key_changes
    ansible.builtin.fail:
      msg: |
        THE FOLLOWING HOST KEY HAS CHANGED

        "{{ item.item }}"

  - name: Update known hosts
    ansible.builtin.known_hosts:
      name: "{{ ansible_host }}"
      key: "{{ inventory_hostname }},{{ item }}"
      path: "{{ ssh_known_hosts_file }}"
      state: present
    with_items: "{{ ssh_keyscan.stdout_lines }}"
...
