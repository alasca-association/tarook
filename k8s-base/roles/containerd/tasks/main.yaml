---
- name: Ensure /etc/containerd directory is present
  become: true
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Add docker repository
  become: true
  block:
  - name: Add GPG apt key
    ansible.builtin.apt_key:
      url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
      state: present
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Add docker repository
    ansible.builtin.apt_repository:
      repo: "deb https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
      state: present
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Update apt package cache
    ansible.builtin.apt:
      update_cache: true
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

- name: Install containerd
  become: true
  block:
  - name: Ensure 'containerd' package is absent
    ansible.builtin.apt:
      state: absent
      name:
      - containerd
    register: containerd_remove
    until: containerd_remove is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Install 'containerd.io' package from docker repository
    ansible.builtin.apt:
      state: present
      name:
      - containerd.io
    register: package_install
    until: package_install is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

- name: Create containerd daemon configuration
  become: true
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/containerd/config.toml
    owner: root
    group: root
    mode: 0640
  register: configuration_update

- name: Create the container mirror directory
  become: yes
  file:
    path: /etc/containerd/certs.d
    state: directory
    # I am not sure about the mode, in theory the cert.d directory can
    # contain client keys for accessing a registry, if we support
    # this, it probably shouldn't be world readable, on the other hand
    # just protecting the keys with permissions should suffice
    mode: 0755
    owner: root
    group: root

- name: Configure container mirrors
  become: yes
  # NOTE: containerd need not be reloaded for changes to the mirrors
  # to take effect.
  include_tasks: configure_mirror.yaml
  loop: "{{ container_mirrors }}"

- name: Reboot the node of initial installation
  become: yes
  when: package_install.changed and not kubernetes_dir.stat.exists
  reboot: {}

- name: Restart containerd
  become: true
  # Only restart if something changed AND we're allowed to do the restart
  when:
  - package_install.changed or containerd_remove.changed or configuration_update.changed
  - _allow_disruption or install_status == 'k8s_not_installed'  # noqa no-handler
  ansible.builtin.systemd:
    enabled: true
    state: restarted
    daemon_reload: true
    name: containerd
...
