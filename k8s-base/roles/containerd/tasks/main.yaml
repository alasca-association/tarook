- name: Ensure /etc/containerd directory is present
  become: yes
  file:
    path: /etc/containerd
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Add docker repository
  become: true
  block:
  - name: Add GPG apt key
    ansible.builtin.apt_key:
      url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
      state: present
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Add docker repository
    apt_repository:
      repo: "deb https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
      state: present
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Update apt package cache
    ansible.builtin.apt:
      update_cache: true
    register: apt_action
    until: apt_action is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

- name: Install containerd
  become: true
  block:
  - name: Ensure 'containerd' package is absent
    apt:
      state: absent
      name:
      - containerd
    register: containerd_remove
    until: containerd_remove is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

  - name: Install 'containerd.io' package from docker repository
    apt:
      state: present
      name:
      - containerd.io
    register: package_install
    until: package_install is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

- name: Create containerd daemon configuration
  become: yes
  template:
    src: config.toml.j2
    dest: /etc/containerd/config.toml
    owner: root
    group: root
    mode: 0640
  register: configuration_update

- name: Restart containerd
  become: yes
  # Only restart if something changed AND we're allowed to do the restart
  when:
  - package_install.changed or containerd_remove.changed or configuration_update.changed
  - _allow_disruption or install_status == 'k8s_not_installed' # noqa no-handler
  systemd:
    enabled: yes
    state: restarted
    daemon_reload: yes
    name: containerd
