---
# This playbook is used for testing offline installations in k8s
# clusters atop OpenStack. It allows to restrict the internet
# connection of the cluster.
# It only works when triggered from `../actions/offline_cluster.py`
# which takes care of the setup on the OpenStack side.
- name: Establish connectivity to the nodes
  hosts: frontend
  gather_facts: false
  vars_files:
  - vars/disruption.yaml
  - vars/etc.yaml
  roles:
  - role: detect_user
    tags: detect_user

- name: Offline the Cluster
  hosts: frontend
  gather_facts: false
  become: true
  tasks:
  - name: Configure nftables to offline the nodes
    ansible.builtin.template:
      src: nftables_take_offline.conf.j2
      dest: /etc/nft.d/00take-offline.conf
      owner: root
      group: root
      mode: 0640

  - name: Restart nftables
    ansible.builtin.service:
      name: nftables
      state: restarted
...
