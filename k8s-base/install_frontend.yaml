---
- name: Initial sanity checks
  hosts: localhost
  gather_facts: false
  vars_files:
  - vars/etc.yaml
  roles:
  - validate_configuration

- name: Establish connectivity to the nodes
  hosts: frontend
  gather_facts: false
  strategy: free
  vars_files:
  - vars/disruption.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: detect_user
    tags: detect_user
  - role: ssh-known-hosts
    tags: ssh-known-hosts
  - role: prepare-node
    tags: prepare-node
  - role: is-frontend-initialized
    tags: update_system

- name: Disable SELinux
  hosts: frontend
  roles:
  - role: disable_selinux
    tags: disable_selinux
    when: ansible_os_family == 'RedHat'

- name: Harden SSH
  hosts: frontend
  become: yes
  collections:
  - devsec.hardening
  vars_files:
  - vars/ssh-hardening.yaml
  roles:
  - role: devsec.hardening.ssh_hardening
    tags: harden-ssh

- name: Upgrade uninitialized nodes
  hosts: uninitialized_frontend_nodes
  vars_files:
  - vars/disruption.yaml
  - vars/retries.yaml
  roles:
  - role: update_system
    tags: update_system

- name: Rollout company users
  hosts: gateways
  gather_facts: true
  tasks:
  - name: Rollout company users
    when: cah_users_rollout
    ansible.builtin.include_role:
      name: ch-role-users
    tags:
    - ch-role-users

- name: Configure frontend server services
  hosts: frontend
  gather_facts: true
  vars_files:
  - vars/disruption.yaml
  - vars/auto_generated_preamble.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: ntp
    tags: ntp
  - role: keepalived
    tags: keepalived
  - role: haproxy
    tags: haproxy
  - role: prometheus-haproxy-exporter
    tags: prometheus-haproxy-exporter
  - role: prometheus-keepalived-exporter
    tags: prometheus-keepalived-exporter

- name: Configure load balancer and VPN gateway
  hosts: gateways
  gather_facts: true
  vars_files:
  - vars/disruption.yaml
  - vars/auto_generated_preamble.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: bird
    tags: bird
  - role: nftables
    tags: nftables
  - role: wireguard
    tags: wireguard
  - role: prometheus-node-exporter
    tags: prometheus-node-exporter
  - role: monitoring-system-update-status
    tags: monitoring-system-update-status
  - role: journald
    tags: journald
  - role: configure-automatic-system-updates
    tags: configure-automatic-system-updates
  - role: ipsec-vpn
    tags: ipsec-vpn

...
