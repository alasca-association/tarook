---
- name: Initial sanity checks
  hosts: localhost
  gather_facts: false
  vars_files:
  - vars/etc.yaml
  roles:
  - validate_configuration

- name: Establish connectivity to the nodes
  hosts: frontend
  gather_facts: false
  strategy: free
  vars_files:
  - vars/disruption.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: detect_user
    tags: detect_user
  - role: ssh-known-hosts
    tags: ssh-known-hosts
  - role: prepare-node
    tags: prepare-node
  - role: is-frontend-initialized
    tags: update_system

- name: Disable SELinux
  hosts: frontend
  roles:
  - role: disable_selinux
    tags: disable_selinux
    when: ansible_os_family == 'RedHat'

- name: Harden SSH
  hosts: frontend
  become: true
  vars_files:
  - vars/ssh-hardening.yaml
  roles:
  # https://github.com/dev-sec/ansible-collection-hardening/
  - role: devsec.hardening.ssh_hardening
    tags: harden-ssh

- name: Upgrade uninitialized nodes
  hosts: uninitialized_frontend_nodes
  vars_files:
  - vars/disruption.yaml
  - vars/retries.yaml
  roles:
  - role: update_system
    tags: update_system

- name: Configure frontend server services
  hosts: frontend
  gather_facts: true
  vars_files:
  - vars/disruption.yaml
  - vars/auto_generated_preamble.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: ntp
    tags: ntp
  - role: keepalived
    tags: keepalived
  - role: haproxy
    tags: haproxy

- name: Configure load balancer and VPN gateway
  hosts: gateways
  gather_facts: true
  vars_files:
  - vars/disruption.yaml
  - vars/auto_generated_preamble.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  roles:
  - role: bird
    tags: bird
  - role: prometheus-bird-exporter
    tags: prometheus-bird-exporter
  - role: nftables
    tags: nftables
  - role: wireguard
    tags: wireguard
  - role: journald
    tags: journald
  - role: configure-automatic-system-updates
    tags: configure-automatic-system-updates
  - role: ipsec-vpn
    tags: ipsec-vpn

...
