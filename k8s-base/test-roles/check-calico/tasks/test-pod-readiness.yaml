---
- name: Check that calico/node and typha Pods are running
  delegate_to: "{{ groups['masters'] | first }}"
  run_once: true
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    DATASTORE_TYPE: kubernetes

  block:
  - name: Check running and readiness status of calico-node pods
    kubernetes.core.k8s_info:
      kind: Pod
      label_selectors:
      - app.kubernetes.io/name=calico
      - app.kubernetes.io/component=calico-node
    register: pod_calico_node
    failed_when: ( pod_calico_node.resources[0].status.phase != "Running" ) and ( pod_calico_node.resources[0].status.containerStatuses[0].ready != true )

  - name: Check running and readiness status of calico-typha pods
    kubernetes.core.k8s_info:
      kind: Pod
      label_selectors:
      - app.kubernetes.io/name=calico
      - app.kubernetes.io/component=calico-typha
    register: pod_calico_tpyha
    failed_when: ( pod_calico_node.resources[0].status.phase != "Running" ) and ( pod_calico_node.resources[0].status.containerStatuses[0].ready != true )
