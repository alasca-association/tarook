# Create a bunch of pods for iperf measurements.
#
# Requires to label two nodes with label=iperf1 and label=iperf2 respectively to schedule the pods.
# debian1 will run on the same node as iperf-server, debian2 will run on the other node.
---
apiVersion: v1
kind: Pod
metadata:
  name: iperf-server
  labels:
    app: iperf
spec:
  nodeSelector:
    label: iperf1
  containers:
  - name: iperf
    image: markbnj/cluster-iperf:0.0.1
    ports:
    - containerPort: 5001
    env:
    - name: ROLE
      value: server
    - name: SERVER_ADDR
      value: 0.0.0.0
    args: ["-p", "5001"]
---
apiVersion: v1
kind: Pod
metadata:
  name: debian1
spec:
  containers:
  - name: debian
    image: debian:stable
    command: ["tail", "-f", "/dev/null"]
  nodeSelector:
    label: iperf1
---
apiVersion: v1
kind: Pod
metadata:
  name: debian2
spec:
  containers:
  - name: debian
    image: debian:stable
    command: ["tail", "-f", "/dev/null"]
  nodeSelector:
    label: iperf2
---
kind: Service
apiVersion: v1
metadata:
  name: iperf
spec:
  selector:
    app: iperf
  type: LoadBalancer
  ports:
  - name: tcp
    port: 5001
    targetPort: 5001
