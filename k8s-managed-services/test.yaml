---
# We test the monitoring down here because we need to give Prometheus a bit of
# time to boot and collect the first bits of data.
- name: Check monitoring
  hosts: orchestrator
  gather_facts: no
  vars_files:
  - vars/retries.yaml
  pre_tasks:
    - name: include env vars
      ansible.builtin.include_vars:
        dir: "{{ kms_vars_directory }}"
      tags:
      - always
  tags:
  - test-mk8s-ms
  - check-mk8s-ms
  roles:
  - role: monitoring_v1_test
    tags:
    - test-mk8s-ms/monitoring_v1
    - check-mk8s-ms/monitoring_v1
    - monitoring_v1_test
    when: (k8s_monitoring_enabled | bool) and (monitoring_use_jsonnet_setup | default(False))

  - role: monitoring_v2_test
    tags:
    - test-mk8s-ms/monitoring_v2
    - check-mk8s-ms/monitoring_v2
    - monitoring_v2_test
    when: (k8s_monitoring_enabled | bool) and not (monitoring_use_jsonnet_setup | default(False))

  - role: device_plugin_v1_test
    tags:
    - test-mk8s-ms/gpu-support
    - check-mk8s-ms/gpu-support
    - device_plugin_v1_test
    when: "k8s_is_gpu_cluster"
...
