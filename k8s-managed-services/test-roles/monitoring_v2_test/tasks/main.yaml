---
- name: Run the test
  block:
  - name: Discover IP address of prometheus service
    k8s_info:
      namespace: monitoring
      name: prometheus-operated
      api_version: v1
      kind: Endpoints
    register: prometheus_endpoint
    until: |
        (prometheus_endpoint.resources | default(False))
        and (prometheus_endpoint.resources[0].subsets | default(False))
        and (prometheus_endpoint.resources[0].subsets[0].addresses | default(False))
        and (prometheus_endpoint)
    retries: 60
    delay: 3

  - name: Set prometheus cluster IP and web port
    set_fact:
      prometheus_cluster_ip: "{{ prometheus_endpoint.resources[0].subsets[0].addresses[0].ip }}"
      prometheus_web_port: "{{ (prometheus_endpoint.resources[0].subsets[0].ports | selectattr('name', 'in', ['web','http-web']) | first).port }}"

  - name: information about config
    debug:
      msg: "This test is going to use the prometheus at {{ prometheus_cluster_ip }}:{{ prometheus_web_port }}"

  - name: Scrape prometheus endpoints
    block:
    - name: Create the prometheus test scraper namespace
      k8s:
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ check_prometheus_scraping_namespace }}"
            labels:
              monitoring-checks: "{{ check_prometheus_scraping_namespace }}"
        validate:
          fail_on_error: yes
          strict: yes
        state: present

    - name: Create the prometheus test scraper Pod
      k8s:
        definition: "{{ lookup('template', 'scraper.yaml.j2') }}"
        apply: yes
        state: "present"
        wait: yes
        validate:
          fail_on_error: yes
          strict: yes
      register: scraper_info

    - name: Scrape endpoints for prometheus stack itself
      include_tasks: scrape_prometheus_stack.yaml

    - name: Scrape endpoints for managed services
      include_tasks: scrape_managed_services.yaml

  - name: Delete Namespace
    k8s:
      api_version: v1
      name: "{{ check_prometheus_scraping_namespace }}"
      kind: Namespace
      state: absent
      wait: true
      validate:
        fail_on_error: yes
        strict: yes
    tags:
      - test-cleanup
