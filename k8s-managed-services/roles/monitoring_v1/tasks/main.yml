---
- name: Create namespace
  when: k8s_monitoring_enabled
  kubernetes.core.k8s:
    apply: yes
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ monitoring_namespace }}"
    validate:
      fail_on_error: yes
      strict: yes
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"
  tags:
  - monitoring
  - thanos

- ansible.builtin.include_tasks: kube_monitoring.yml
  when: k8s_monitoring_enabled
  tags:
  - monitoring

- ansible.builtin.import_tasks: internet_probe.yaml
  when: k8s_monitoring_enabled and monitoring_internet_probe
  tags:
    - internet_probe

- name: Expose Prometheus with a NodePort
  when: k8s_monitoring_enabled and k8s_global_monitoring_enabled
  tags:
    - ch-k8s-global-monitoring
    - ch-k8s-global-monitoring-nodeport
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'prometheus-nodeport.yaml') }}"
    validate:
      fail_on_error: yes
      strict: yes
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"
...
