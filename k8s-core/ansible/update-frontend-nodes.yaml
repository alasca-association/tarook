---
- name: Initialize node connection
  import_playbook: "connect-to-nodes.yaml"
  vars:
    target_hosts: frontend

- name: Fail if node got not bootstrapped once, yet
  any_errors_fatal: true
  hosts: frontend
  tasks:
  - name: Fail if node got not bootstrapped once, yet
    when: not ansible_local['bootstrap']['bootstrapped'] | default(False) | bool
    fail:
      msg: |
        ERROR

        We're at an advanced stage of the rollout,
        but the node did not get bootstrapped yet!
        Please ensure the k8s-core/bootstrap playbook
        is executed at least once against every node
        before proceeding.
        This is automatically done if the install-all
        playbook of either k8s-core or k8s-supplements is executed.

- name: Group frontend nodes by initialization status
  hosts: frontend
  gather_facts: true
  tags: update-frontend-nodes
  tasks:
  - name: Group frontend nodes by frontend initialization status
    ansible.builtin.group_by:
      key: "{{ ansible_local['frontend-initialized']['frontend_install_status'] | default('not_initialized') }}_frontend_nodes"
  - name: Group frontend nodes by Kubernetes initialization status
    ansible.builtin.group_by:
      key: "{{ ansible_local['kubernetes-initialized']['k8s_install_status'] | default('not_initialized') }}_kubernetes_nodes"

- name: Upgrade uninitialized frontend nodes
  gather_facts: true
  hosts: not_initialized_frontend_nodes:&not_initialized_kubernetes_nodes
  vars_files:
  - vars/disruption.yaml
  - vars/retries.yaml
  tags: update-frontend-nodes
  roles:
  - role: update-system
    tags: update-system

- name: Upgrade initialized frontend nodes
  gather_facts: true
  hosts: initialized_frontend_nodes
  vars_files:
  - vars/disruption.yaml
  - vars/retries.yaml
  serial: 1
  tags: update-frontend-nodes
  roles:
  - role: update-system
    tags: update-system
    when: _allow_disruption
...
