#jinja2: lstrip_blocks: True
{{ _auto_generated_preamble }}

global
  log /dev/log local0 debug
  stats socket /tmp/haproxy_admin.sock mode 660 group haproxy level admin expose-fd listeners
  user haproxy
  group haproxy
  stats timeout 30s
  daemon
  maxconn {{ haproxy_global_maxconn }}

defaults
  log     global
  option log-health-checks
  timeout connect 5000
  timeout client  50000
  timeout server  50000

frontend healthz
  bind 127.0.0.1:6669
  mode http
  monitor-uri /healthz
  option dontlognull

{% for port in lb_ports %}
{% set backend_options = ["verify", "none"] %}
{% if port is mapping %}
{% set front_port = port.external %}
{% set back_port = port.nodeport %}
{% set layer = port.layer %}
{% if port.use_proxy_protocol %}
{% set _= backend_options.append("send-proxy") %}
{% endif %}
{% else %}
{% set front_port = port %}
{% set back_port = port %}
{% set layer = "tcp" %}
{% set use_proxy_protocol = false %}
{% endif %}

frontend k8s-lb-frontend-{{ front_port }} # Autogenerated
  {% if ipv4_enabled %}
  bind 0.0.0.0:{{ front_port }}
  {% endif %}
  {% if ipv6_enabled %}
  bind :::{{ front_port }}
  {% endif %}
  mode {{ layer }}
  log global
  option tcplog
  timeout client 600s
  maxconn {{ haproxy_frontend_nodeport_maxconn }}
  default_backend k8s-lb-backend-{{ back_port }}

backend k8s-lb-backend-{{ back_port }} # Autogenerated
  mode {{ layer }}
{% if layer == 'http' %}
  option forwardfor # Adds `X-Forwarded-For` header
{% endif %}
  option redispatch
  log global
  balance roundrobin
  timeout connect 10s
  timeout server 600s

  {% for host in groups['masters'] %}
  {% if ipv4_enabled %}
  server {{ host }}-v4 {{ hostvars[host]['local_ipv4_address'] }}:{{ back_port }} {{ backend_options | join(' ') }}
  {% endif %}
  {% if ipv6_enabled %}
  server {{ host }}-v6 {{ hostvars[host]['local_ipv6_address'] }}:{{ back_port }} {{ backend_options | join(' ') }}
  {% endif %}
  {% endfor %}

{% endfor %}

listen stats
  {% if ipv4_enabled %}
  bind 0.0.0.0:{{ haproxy_stats_port }}
  {% endif %}
  {% if ipv6_enabled %}
  bind :::{{ haproxy_stats_port }}
  {% endif %}
  mode http
  log global

  maxconn 2
  stats enable
  stats hide-version
  stats refresh 10s
  stats show-node
  stats auth admin:Eamo4uij
  stats uri /haproxy?stats
