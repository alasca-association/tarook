---
- name: Initialize node connection
  import_playbook: "connect-to-nodes.yaml"

- name: Prepare node
  hosts: "{{ target_hosts | default('all:!orchestrator') }}"
  gather_facts: true # we need facts and at this point in time we can get them
  vars_files:
  - vars/auto_generated_preamble.yaml
  - vars/disruption.yaml
  - vars/etc.yaml
  - vars/retries.yaml
  pre_tasks:
  - name: Update apt repositories cache
    become: true
    apt:
      update_cache: true
    tags: always
  - name: Ensure static fact directory exists
    become: true
    file:
      state: directory
      path: /etc/ansible/facts.d
      owner: root
      group: root
      mode: u=rwx,go=rx
  roles:
  - role: bootstrap/journald
    tags:
    - journald
    - bootstrap
  - role: bootstrap/configure-automatic-system-updates
    tags:
    - configure-automatic-system-updates
    - bootstrap
  - role: bootstrap/disable-swap
    tags:
    - disable-swap
    - bootstrap
  - role: bootstrap/remove_snap
    tags:
    - remove_snap
    - bootstrap
  - role: bootstrap/ntp
    tags:
    - ntp
    - bootstrap
  - role: bootstrap/net-forwarding
    tags:
    - net-forwarding
    - bootstrap

- name: Configure Proxy support
  hosts: "{{ target_hosts | default('all:!orchestrator') }}"
  vars_files:
  - vars/auto_generated_preamble.yaml
  - vars/retries.yaml
  roles:
  - role: proxy-support
    when: cluster_behind_proxy | default(false)
    tags: proxy-support

- name: Update apt cache
  hosts: "{{ target_hosts | default('all:!orchestrator') }}"
  vars_files:
  - vars/retries.yaml
  tasks:
  - name: Update apt cache
    become: true
    ansible.builtin.apt:
      update_cache: true
    register: update_apt
    until: update_apt is not failed
    retries: "{{ network_error_retries }}"
    delay: "{{ network_error_delay }}"

- name: Detect GPU
  hosts: "{{ target_hosts | default('all:!orchestrator') }}"
  vars_files:
  - vars/retries.yaml
  roles:
  - role: bootstrap/gpu-support-detection
    when:
    - "'gateways' not in group_names"
    - ansible_local['gpu-node']['node_has_gpu'] is not defined
    tags:
    - bootstrap
    - gpu-support-detection
...
