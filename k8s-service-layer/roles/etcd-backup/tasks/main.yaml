- name: Include S3 secrets config file
  include_vars:
    file: "{{ etcd_backup_config_path }}"

- name: Create a Secret to save s3 credentials
  k8s:
    state: present
    apply: true
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ etcd_backup_secret_name }}"
        namespace: "{{ etcd_backup_namespace }}"
      data:
        access: "{{ access_key | b64encode }}"
        secret: "{{ secret_key | b64encode }}"
    validate:
      fail_on_error: true

- name: Install required packages for s3
  ansible.builtin.pip:
    name:
      - boto3
      - botocore

- name: Apply retention policy on bucket
  environment:
    EC2_ACCESS_KEY: "{{ access_key }}"
    EC2_SECRET_KEY: "{{ secret_key }}"
    EC2_URL: "{{ endpoint_url }}"
    EC2_REGION: "{{ region }}"
  block:
    - name: Check if bucket exists
      aws_s3_bucket_info:
        name: "{{ etcd_backup_bucket_name }}"
      register: bucket_info

    - name: "Configure a lifecycle rule on a bucket to expire (delete) items after {{ etcd_backup_days_of_retention }}"
      s3_lifecycle:
        name: "{{ etcd_backup_bucket_name }}"
        expiration_days: "{{ etcd_backup_days_of_retention }}"
        prefix: "{{ etcd_backup_file_prefix }}"
        status: enabled
        state: present
      register: retention
      changed_when: retention.changed == true
      when: bucket_info.buckets | length > 0

- name: Deploy yaook operator etcd backup chart
  community.kubernetes.helm:
    chart_ref: etcdbackup
    chart_repo_url: https://charts.yaook.cloud/operator/stable/
    chart_version: "{{ etcd_backup_chart_version }}"
    release_namespace: "{{ etcd_backup_namespace }}"
    release_name: "{{ etcd_backup_name }}"
    release_state: present
    values: "{{ lookup('template', 'etcd_backup.yaml.j2') | from_yaml }}"
  when: bucket_info.buckets | length > 0