- name: Create namespace
  community.kubernetes.k8s:
    apply: yes
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ monitoring_namespace }}"
    validate:
      fail_on_error: yes
      strict: yes
  tags:
  - monitoring
  - thanos

- name: Create thanos secret
  include_role:
    name: monitoring_thanos_secret_v1

- import_tasks: kube_thanos.yml
  when: k8s_monitoring_enabled and monitoring_use_thanos
  tags:
  - thanos

- name: Wait for thanos
  block:
  - name: Wait for thanos-compact
    k8s_info:
      kind: StatefulSet
      namespace: "{{ monitoring_namespace }}"
      label_selectors:
        - app.kubernetes.io/name=thanos-compact
        - app.kubernetes.io/component=database-compactor
    register: thanos_compact_info
    delay: 1
    retries: 120
    until: |
      thanos_compact_info.resources | default(False)
      and thanos_compact_info.resources[0].status | default(False)
      and thanos_compact_info.resources[0].status.readyReplicas | default(0) > 0

  - name: Wait for thanos-store
    k8s_info:
      kind: StatefulSet
      namespace: "{{ monitoring_namespace }}"
      label_selectors:
        - app.kubernetes.io/name=thanos-store
        - app.kubernetes.io/component=object-store-gateway
    register: thanos_store_info
    delay: 1
    retries: 120
    until: |
      thanos_store_info.resources | default(False)
      and thanos_store_info.resources[0].status | default(False)
      and thanos_store_info.resources[0].status.readyReplicas | default(0) > 0
