---
- name: configure jsonnet
  tags:
    - k8s-monitoring-build
  template:
    src: thanos.jsonnet
    dest: "{{ monitoring_jsonnet_dir_thanos }}/config.jsonnet"
    mode: 0664

- name: rebuild
  tags:
    - k8s-monitoring-build
  command:
  args:
    argv:
    - "make"
    - "-f"
    - "../Makefile"
    - "build"
    chdir: "{{ monitoring_jsonnet_dir_thanos }}"
  changed_when: false

- name: apply manifests
  kubernetes.core.k8s:
    state: present
    apply: yes
    definition: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/' + item) }}"
    validate:
      fail_on_error: yes
      strict: yes
  loop: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/manifests.files.json', errors='strict' if k8s_monitoring_enabled and monitoring_use_thanos else 'warn' ) | default(' [] ', true) | from_json }}"  # noqa 204
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"
...
