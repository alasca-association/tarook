# Update k8s-rook from 1.6.* to 1.7.*
# https://rook.io/docs/rook/v1.7/ceph-upgrade.html#rook-operator-upgrade-process

# Verify that the Ceph cluster is healthy
- name: Include cluster health verification
  include_tasks: cluster_health_verification.yaml

- name: Configure k8s resources
  block:
    - name: Apply updated common resources
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'v1.7/common.yaml.j2') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Apply updated Custom Resource Definitions (CRDs)
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'v1.7/crds.yaml.j2') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

    - name: Apply new rook-ceph-operator manifest (v1.7)
      kubernetes.core.k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'v1.7/operator.yaml.j2') }}"
        validate:
          fail_on_error: yes
          strict: yes
      # Retry this task on failures
      register: k8s_apply
      until: k8s_apply is not failed
      retries: "{{ k8s_error_retries }}"
      delay: "{{ k8s_error_delay }}"

# The upgrade will take at least 5 minutes
# We are pausing here to prevent spamming the output with failures
- name: The upgrade will take several minutes, pausing ansible for 5m
  pause:
    seconds: 300

- name: Wait until the ceph cluster's core components are fully updated
  include_tasks: wait_for_rook_upgrade.yaml

- name: Give the rook-based ceph cluster time (20s) to stabilize
  pause:
    seconds: 20

- name: Include cluster health verification
  include_tasks: cluster_health_verification.yaml
