# Update k8s-rook from 1.2.* to 1.3.*
# https://rook.io/docs/rook/v1.3/ceph-upgrade.html#rook-operator-upgrade-process

# Verify that the Ceph cluster is healthy
- name: Include cluster health verification
  include_tasks: cluster_health_verification.yaml

- name: Configure k8s resources
  block:
    - name: Apply modified privileges (RBAC)
      k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'upgrade-from-v1.2-apply-RBAC.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes

    - name: Apply modified Custom Resource Definitions (CRDs)
      k8s:
        state: present
        apply: yes
        definition: "{{ lookup('file', 'upgrade-from-v1.2-crds.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes

    # necessary because the volumeclaimtemplate needs to be called data,
    # not ceph-data. otherwise, the operator will not update the osds
    # because it claims it is missing the data template
    - name: Apply new cluster manifest (v1.3)
      k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'v1.3/cluster.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes

    - name: Apply new rook-ceph-operator manifest (v1.3)
      k8s:
        state: present
        apply: yes
        definition: "{{ lookup('template', 'v1.3/operator.yaml') }}"
        validate:
          fail_on_error: yes
          strict: yes

