# When an update is requested, the operator will check Cephâ€™s status,
# if it is in HEALTH_ERR it will refuse to do the upgrade.
#
# https://rook.github.io/docs/rook/v1.2/ceph-upgrade.html#ceph-version-upgrades
---
# Verify that the ceph cluster is healthy
- name: Include cluster health verification
  include_tasks: cluster_health_verification.yaml

- name: Patch the image version of the Ceph Cluster (< v16.2.6)
  when: rook_ceph_version is version('v16.2.6', operator='<')
  kubernetes.core.k8s:
    definition:
      kind: CephCluster
      metadata:
        namespace: "{{ rook_namespace }}"
        name: "{{ rook_cluster_name }}"
      spec:
        cephVersion:
          image: "ceph/ceph:{{ rook_ceph_version }}"
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"

- name: Patch the image version of the Ceph Cluster (>= v16.2.6)
  when: rook_ceph_version is version('v16.2.6', operator='>=')
  kubernetes.core.k8s:
    definition:
      kind: CephCluster
      metadata:
        namespace: "{{ rook_namespace }}"
        name: "{{ rook_cluster_name }}"
      spec:
        cephVersion:
          image: "quay.io/ceph/ceph:{{ rook_ceph_version }}"
  # Retry this task on failures
  register: k8s_apply
  until: k8s_apply is not failed
  retries: "{{ k8s_error_retries }}"
  delay: "{{ k8s_error_delay }}"

# The upgrade will take at least 5 minutes
# We are pausing here to prevent spamming the output with failures
- name: The upgrade will take several minutes, pausing ansible for 5m
  pause:
    seconds: 300

- name: Wait until the ceph cluster's core components are fully updated
  include_tasks: wait_for_ceph_upgrade.yaml

- name: Give the rook-based ceph cluster time (20s) to stabilize
  pause:
    seconds: 20

# Verify that the ceph cluster is healthy
- name: Include cluster health verification
  include_tasks: cluster_health_verification.yaml
...
