build_image_mr:
  tags:
    - docker
  image: "${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/nixos/nix:2.21.2"
  stage: build-image
  rules:
  - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    changes:
    - flake.nix
    - flake.lock
    - ci/build-image.yaml
    - ci/container-image/*
    when: always
  - when: never
  before_script:
    - |
      cat > /etc/nix/nix.conf <<EOF
      build-users-group = nixbld
      sandbox = false
      extra-experimental-features = nix-command flakes
      substituters = https://cache.nixos.org/ https://yaook.cachix.org
      trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= yaook.cachix.org-1:m85JtxgDjaNa7hcNUB6Vc/BTxpK5qRCqF4yHoAniwjQ=
      EOF
  script:
  - nix run .#skopeo -- login -u gitlab-ci-token -p "${CI_JOB_TOKEN}" "${CI_REGISTRY}"
  - nix run ".#ciImage.copyToRegistry"
  - export IMAGE_REF_BUILD="${YAOOK_K8S_CI_IMAGE_NAME}:build"
  - export IMAGE_TAG="${CI_COMMIT_SHA:0:8}"
  - export IMAGE_REF_PUSH="${YAOOK_K8S_CI_IMAGE_NAME}:${IMAGE_TAG}"
  - nix run .#skopeo -- --insecure-policy copy "docker://${IMAGE_REF_BUILD}" "docker://${IMAGE_REF_PUSH}"
  - echo "YAOOK_K8S_CI_IMAGE_TAG=$IMAGE_TAG" > image.env

  artifacts:
    reports:
      dotenv: image.env

deploy_image:
  tags:
    - docker
  image: "${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/ay.io/skopeo/stable:latest"
  stage: release
  rules:
  - if: $CI_COMMIT_TAG
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
  - skopeo login -u gitlab-ci-token -p "${CI_JOB_TOKEN}" "${CI_REGISTRY}"
  - skopeo --insecure-policy copy "docker://${YAOOK_K8S_CI_IMAGE_NAME}:${YAOOK_K8S_CI_IMAGE_TAG}" "docker://${YAOOK_K8S_CI_IMAGE_NAME}:${CI_COMMIT_REF_NAME}"
  - |
    if [ "$CI_COMMIT_REF_NAME" == "$CI_DEFAULT_BRANCH" ]; then
      skopeo --insecure-policy copy "docker://${YAOOK_K8S_CI_IMAGE_NAME}:${YAOOK_K8S_CI_IMAGE_TAG}" "docker://${YAOOK_K8S_CI_IMAGE_NAME}:latest";
    fi
