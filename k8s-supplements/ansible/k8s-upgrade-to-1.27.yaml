---
- name: Detect user
  hosts: k8s_nodes
  gather_facts: false
  # we need *all* hosts.
  any_errors_fatal: true
  vars_files:
    - vars/etc.yaml
  roles:
    - role: bootstrap/detect-user
      tags: detect-user

- name: Upgrade Kubernetes nodes
  import_playbook: "{{ ansible_k8s_core_dir }}/upgrade-k8s.yaml"

- name: Overwrite "k8s_version"
  hosts: orchestrator
  tasks:
    - name: Overwrite k8s_version with next_k8s_version
      ansible.builtin.set_fact:
        k8s_version: "{{ next_k8s_version }}"

- name: Update OpenStack components
  import_playbook: connect-k8s-to-openstack.yaml

- name: Update volume snapshot controller
  import_playbook: install-volume-snapshot-controller.yaml

- name: Update Calico
  import_playbook: install-calico.yaml

- name: Update ch-k8s-lbaas
  import_playbook: install-ch-k8s-lbaas.yaml

- name: Update monitoring stack
  import_playbook: install-monitoring.yaml

- name: Final upgrade note
  gather_facts: false
  hosts: masters[0]
  tasks:
    - name: Final upgrade note
      delegate_to: localhost
      ansible.builtin.debug:
        msg: >
          Congratulations!

            \o/     The upgrade to
             |      {{ next_k8s_version }}
            / \     is complete.

          You MUST now change the k8s_version variable to
          {{ next_k8s_version | to_json }}.
...
