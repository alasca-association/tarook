- name: Initial sanity checks
  hosts: localhost
  gather_facts: false
  roles:
    - validate_configuration

- name: Establish connectivity to the nodes
  hosts: gateways
  gather_facts: false
  strategy: free
  vars_files:
  - vars/disruption.yaml
  roles:
  - detect_user
  - role: ssh-known-hosts
    tags: ssh-known-hosts
  - role: is-gateway-initialized
    tags: update_system

- name: Harden SSH
  hosts: gateways
  become: yes
  collections:
  - devsec.hardening
  roles:
  - role: devsec.hardening.ssh_hardening
    tags: harden-ssh

- name: Upgrade uninitialized nodes
  hosts: uninitialized_gateways
  vars_files:
  - vars/disruption.yaml
  roles:
  - role: update_system
    tags: update_system

- name: Upgrade initialized nodes
  hosts: initialized_gateways
  vars_files:
  - vars/disruption.yaml
  serial: 1
  roles:
  - role: update_system
    tags: update_system
    when: _allow_disruption

- name: Configure load balancer and VPN gateway
  hosts: gateways
  gather_facts: true
  vars_files:
  - vars/disruption.yaml
  - vars/auto_generated_preamble.yaml
  roles:
  - role: passwordstore
    tags: passwordstore
  - role: nftables
    tags: nftables
  - role: ntp
    tags: ntp
  - role: keepalived
    tags: keepalived
  - role: haproxy
    tags: haproxy
  - role: wireguard
    tags: wireguard
  - role: ch-role-users
    tags: ch-role-users
    when: cah_users_rollout
  - role: prometheus-haproxy-exporter
    tags: prometheus-haproxy-exporter
  - role: prometheus-keepalived-exporter
    tags: prometheus-keepalived-exporter
  - role: prometheus-node-exporter
    tags: prometheus-node-exporter
  - role: monitoring-system-update-status
    tags: monitoring-system-update-status
  - role: journald
    tags: journald
  - role: configure-automatic-system-updates
    tags: configure-automatic-system-updates
  - role: bird
    tags: bird
  - role: ipsec-vpn
    tags: ipsec-vpn
  - role: wireguard-site-to-site
    tags: wireguard-site-to-site
