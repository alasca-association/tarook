---
- name: Deploy LBaaS controller
  when: ch_k8s_lbaas
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  block:
  - name: Create LBaaS controller PodSecurityPolicy objects
    k8s:
      apply: yes
      definition: "{{ lookup('template', 'controller-psp.yaml') }}"
      validate:
        fail_on_error: yes
        strict: yes
    when: k8s_use_podsecuritypolicies

  - name: Configure LBaaS controller
    k8s:
      apply: yes
      definition:
        apiVersion: v1
        kind: Secret
        type: Opaque
        data:
          controller-config.toml: "{{ lookup('template', 'controller-config.toml') | b64encode }}"
        metadata:
          name: ch-k8s-lbaas-controller-config
          namespace: kube-system
      validate:
        fail_on_error: yes
        strict: yes
    notify:
    - restart ch-k8s-lbaas-controller

  - name: Deploy LBaaS controller
    k8s:
      apply: yes
      definition: "{{ lookup('template', item) }}"
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - controller-rbac.yaml
    - controller.yaml
