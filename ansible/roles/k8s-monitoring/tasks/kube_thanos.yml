- name: configure jsonnet
  connection: local
  tags:
    - k8s-monitoring-build
  template:
    src: thanos.jsonnet
    dest: "{{ monitoring_jsonnet_dir_thanos }}/config.jsonnet"

- name: rebuild
  connection: local
  tags:
    - k8s-monitoring-build
  command:
  args:
    argv:
    - "make"
    - "-f"
    - "../Makefile"
    - "build"
    chdir: "{{ monitoring_jsonnet_dir_thanos }}"
  changed_when: false

- name: apply manifests
  k8s:
    state: present
    apply: yes
    definition: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/' + item) }}"
    validate:
      fail_on_error: yes
      strict: yes
  loop: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/manifests.files.json' ) | from_json }}"
