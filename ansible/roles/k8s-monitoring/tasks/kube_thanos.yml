- name: configure jsonnet
  become: no
  connection: local
  tags:
    - k8s-monitoring-build
  template:
    src: thanos.jsonnet
    dest: "{{ monitoring_jsonnet_dir_thanos }}/config.jsonnet"

- name: rebuild
  become: no
  connection: local
  tags:
    - k8s-monitoring-build
  command:
  args:
    argv:
    - "make"
    - "-f"
    - "../Makefile"
    - "build"
    chdir: "{{ monitoring_jsonnet_dir_thanos }}"
  changed_when: false

- name: apply manifests
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  k8s:
    state: present
    apply: yes
    definition: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/' + item) }}"
    validate:
      fail_on_error: yes
      strict: yes
  loop: "{{ lookup('file', monitoring_jsonnet_dir_thanos + '/manifests.files.json', errors='strict' if monitoring and monitoring_use_thanos else 'warn' ) | default(' [] ', true) | from_json }}"  # noqa 204
