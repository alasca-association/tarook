- name: Create namespace
  # this would also be done by kube_monitoring, but we need to do it here since
  # it is shared by both
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: monitoring
  k8s:
    apply: yes
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ monitoring_namespace }}"
    validate:
      fail_on_error: yes
      strict: yes
  tags:
  - monitoring
  - thanos

- name: Configure default PSP
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: monitoring
  k8s:
    definition: "{{ lookup('template', 'default-psp.yaml') }}"
    apply: yes
    state: "{{ k8s_use_podsecuritypolicies | default(False) | ternary('present', 'absent') }}"
    validate:
      fail_on_error: yes
      strict: yes
  tags:
  - monitoring
  - thanos

- include: kube_monitoring.yml
  become: no
  when: monitoring
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  tags:
  - monitoring

- include: kube_thanos.yml
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: monitoring and monitoring_use_thanos
  tags:
  - thanos

- name: Expose Prometheus with a NodePort
  when: monitoring and monitoring_ch_global_monitoring
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  tags:
    - ch-k8s-global-monitoring
    - ch-k8s-global-monitoring-nodeport
  k8s:
    apply: yes
    definition: "{{ lookup('template', 'prometheus-nodeport.yaml') }}"
    validate:
      fail_on_error: yes
      strict: yes
