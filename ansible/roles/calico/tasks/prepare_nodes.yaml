# If you plan to upgrade calico resources:
# curl https://docs.projectcalico.org/manifests/calico.yaml -O

# These tasks also install calicoctl. calicoctl is currently necessary to configure
# Calico specific resources as the Calico CRDs are not designed to 
# be used directly by kubectl. Please refer to the following issue:
# https://github.com/projectcalico/calico/issues/2923

- name: Configure Calico Resources
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  k8s:
    definition: "{{ lookup('file', item) }}"
    apply: yes
    state: present
    validate:
      fail_on_error: yes
      strict: yes
  loop:
    - calico-crds.yaml

- name: Provision Kubernetes user account for the calico cni plugin
  run_once: yes
  become: yes
  environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
  block:
    - name: Generate OpenSSL private key for CA certificate of calico-cni
      openssl_privatekey:
        owner: root
        group: root
        mode: 0600
        path: /etc/kubernetes/pki/calico-cni.key
        size: 4096

    - name: Generate OpenSSL CA Certificate Signing Request (CSR) for calico-cni
      openssl_csr:
        owner: root
        group: root
        mode: 0600
        path: /etc/kubernetes/pki/calico-cni.csr
        privatekey_path: /etc/kubernetes/pki/calico-cni.key
        common_name: calico-cni
        subject:
          CN: calico-cni

    - name: Generate/Sign OpenSSL CA calico-cni Certificate Signing Request (CSR)
      openssl_certificate:
        owner: root
        group: root
        mode: 0600
        path: /etc/kubernetes/pki/calico-cni.crt
        csr_path: /etc/kubernetes/pki/calico-cni.csr
        ownca_path: /etc/kubernetes/pki/ca.crt
        ownca_privatekey_path: /etc/kubernetes/pki/ca.key
        entrust_not_after: "+365d"
        provider: ownca

    - name: Set cluster Kubernetes
      command:
        argv:
          - kubectl
          - config
          - set-cluster
          - kubernetes
          - --certificate-authority=/etc/kubernetes/pki/ca.crt
          - --embed-certs=true
          - --server=https://[{{ networking_fixed_ip }}]:{{ k8s_apiserver_frontend_port | to_json }} # cannot use to_json on the ip
          - --kubeconfig=/etc/cni/net.d/calico-kubeconfig

    - name: Set calico-cni credentials
      command:
        argv:
        - kubectl
        - config
        - set-credentials
        - calico-cni
        - --client-certificate=/etc/kubernetes/pki/calico-cni.crt
        - --client-key=/etc/kubernetes/pki/calico-cni.key
        - --embed-certs=true
        - --kubeconfig=/etc/cni/net.d/calico-kubeconfig

    - name: Set calico-cni context
      command:
        argv:
        - kubectl
        - config
        - set-context
        - default
        - --cluster=kubernetes
        - --user=calico-cni
        - --kubeconfig=/etc/cni/net.d/calico-kubeconfig

    - name: Set use config
      command:
        argv:
          - kubectl
          - config
          - use-context
          - default
          - --kubeconfig=/etc/cni/net.d/calico-kubeconfig

    - name: Fetch calico-cni key from initial master to localhost
      become: yes
      fetch:
        src: "/etc/kubernetes/pki/calico-cni.key"
        dest: "{{ etc_dir }}/"
        flat: yes

    - name: Fetch calico-cni crt from the initial master to localhost
      become: yes
      fetch:
        src: "/etc/kubernetes/pki/calico-cni.crt"
        dest: "{{ etc_dir }}/"
        flat: yes

    - name: Fetch calico-kubeconfig from the initial master to localhost
      become: yes
      fetch:
        src: "/etc/cni/net.d/calico-kubeconfig"
        dest: "{{ etc_dir }}/"
        flat: yes

    - name: Ensure that /etc/cni/net.d/ exists on all k8s_nodes
      delegate_to: "{{ item }}"
      become: yes
      file:
        owner: root
        group: root
        mode: 0750
        path: /etc/cni/net.d/
        state: directory
      loop: "{{ groups['k8s_nodes'] }}"

    - name: Push calico-kubeconfig from localhost to k8s_nodes
      become: yes
      delegate_to: "{{ item }}"
      copy:
        owner: root
        group: root
        mode: 0400
        src: "{{ etc_dir }}/calico-kubeconfig"
        dest: /etc/cni/net.d/calico-kubeconfig
      loop: "{{ groups['k8s_nodes'] }}"

    # just to be sure
    - name: Restrict access to /etc/cni/net.d/calico-kubeconfig
      delegate_to: "{{ item }}"
      file:
        path: /etc/cni/net.d/calico-kubeconfig
        owner: root
        group: root
        mode: 0400
      loop: "{{ groups['k8s_nodes'] }}"

- name: Create user for calico-cni, configure RBAC and create RoleBinding
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  k8s:
    definition: "{{ lookup('file', item) }}"
    apply: yes
    state: "present"
    validate:
      fail_on_error: yes
      strict: yes
  loop:
    - calico-cni-user.yaml

- name: Install and configure Calico CNI Plugin binaries
  become: yes
  block:
    # ToDo: Verify checksum
    - name: Install calicoctl
      delegate_to: "{{ item }}"
      get_url:
        owner: root
        group: root
        mode: 0750
        # cannot use to_json on the calico.version
        url: "https://github.com/projectcalico/calicoctl/releases/download/v{{ image_versions.calico_version }}/calicoctl-linux-amd64"
        dest: /usr/local/bin/calicoctl
        checksum: "{{ calicoctl_binary_checksum }}"
      loop: "{{ groups['masters'] }}"

    - name: Ensure that /opt/cni/bin/ exists
      delegate_to: "{{ item }}"
      file:
        owner: root
        group: root
        mode: 0750
        recurse: yes
        path: /opt/cni/bin/
        state: directory
      loop: "{{ groups['k8s_nodes'] }}"

    # ToDo: Verify Checksum
    - name: Install calico
      delegate_to: "{{ item }}"
      get_url:
        owner: root
        group: root
        mode: 0750
        # cannot use to_json on the calico.version
        url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ image_versions.calico_version }}/calico-amd64"
        dest: /opt/cni/bin/calico
        checksum: "{{ calico_binary_checksum }}"
      loop: "{{ groups['k8s_nodes'] }}"

    # ToDo: Verify checksum
    - name: Install calico-ipam
      delegate_to: "{{ item }}"
      get_url:
        owner: root
        group: root
        mode: 0750
        # cannot use to_json on the calico.version
        url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ image_versions.calico_version }}/calico-ipam-amd64"
        dest: /opt/cni/bin/calico-ipam
        checksum: "{{ calico_ipam_binary_checksum }}"
      loop: "{{ groups['k8s_nodes'] }}"

# https://docs.projectcalico.org/reference/cni-plugin/configuration#kubernetes-specific
- name: Activate k8s Calico CNI plugin on all nodes
  become: yes
  delegate_to: "{{ item }}"
  template:
    owner: root
    group: root
    mode: 0600
    src: 10-calico.conflist.j2
    dest: /etc/cni/net.d/10-calico.conflist
  loop: "{{ groups['k8s_nodes'] }}"
