# These tasks also install calicoctl. calicoctl is currently necessary to configure
# Calico specific resources as the Calico CRDs are not designed to
# be used directly by kubectl. Please refer to the following issue:
# https://github.com/projectcalico/calico/issues/2923

- name: Install and configure Calico CNI Plugin binaries
  become: yes
  block:
    - name: Install calicoctl
      get_url:
        owner: root
        group: root
        mode: 0750
        url: "https://github.com/projectcalico/calicoctl/releases/download/v{{ image_versions.calico_version }}/calicoctl-linux-amd64"
        dest: /usr/local/bin/calicoctl
        checksum: "{{ calicoctl_binary_checksum }}"

    - name: Ensure that /opt/cni/bin/ exists
      file:
        owner: root
        group: root
        mode: 0750
        recurse: yes
        path: /opt/cni/bin/
        state: directory

    - name: Install calico
      get_url:
        owner: root
        group: root
        mode: 0750
        url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ image_versions.calico_version }}/calico-amd64"
        dest: /opt/cni/bin/calico
        checksum: "{{ calico_binary_checksum }}"

    - name: Install calico-ipam
      get_url:
        owner: root
        group: root
        mode: 0750
        url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ image_versions.calico_version }}/calico-ipam-amd64"
        dest: /opt/cni/bin/calico-ipam
        checksum: "{{ calico_ipam_binary_checksum }}"

# https://docs.projectcalico.org/reference/cni-plugin/configuration#kubernetes-specific
- name: Activate k8s Calico CNI plugin on all nodes
  become: yes
  template:
    owner: root
    group: root
    mode: 0600
    src: 10-calico.conflist.j2
    dest: /etc/cni/net.d/10-calico.conflist
