router id {{ local_ipv4_address }};
table master;
debug protocols all;

protocol kernel {
    table master;
    scan time 60;
    import none;
    export all;
}

protocol direct {
    table master;
    import filter {
        scope = SCOPE_HOST;
        accept;
    };
    export none;
}

protocol device {
    table master;
    scan time 60;
    import none;
    export none;
}

{% for hostname in groups['masters'] %}
{% set peer = hostvars[hostname] %}
protocol bgp {{ hostname | replace('-', '_') }} {
    local {{ local_ipv4_address }} as {{ calico.gw_asnumber }}; # gw_asnumber is set by calico bgp setup
    neighbor {{ peer.local_ipv4_address }} as {{ calico.k8s_node_asnumber }};
    multihop;
    import all;
    export none;
}

{% endfor %}


include "/etc/bird.d/*.conf";
