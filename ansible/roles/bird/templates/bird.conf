router id {{ local_ipv4_address }};

protocol kernel {
    scan time 60;
    import none;
    export all;
}

protocol direct {
    import all;
    export none;
}

protocol device {
    scan time 60;
    import none;
    export all;
}

protocol static {
    # FIXME: this hardcodes the first master as nexthop for cluster IP access.
    # That isn’t very HA or good anyways. We’ll most likely not need this for
    # long though. If we do, we need to find a better way, e.g. by extending
    # ch-k8s-lbaas to support cluster IPs locally on the agents.
    route {{ k8s_network_service_subnet }} via {{ hostvars[groups['masters'][0]].local_ipv4_address }};
    import all;
    export none;
}

{% for hostname in groups['k8s_nodes'] %}
{% set peer = hostvars[hostname] %}
protocol bgp {{ hostname | replace('-', '_') }} {
    local {{ local_ipv4_address }} as 65000;
    neighbor {{ peer.local_ipv4_address }} as 64512;
    multihop;
    import all;
    export none;
}

{% endfor %}
