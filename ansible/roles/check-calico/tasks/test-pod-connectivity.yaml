- name: Create a Test-Pod on each k8s-node and check that each Pod can ping each other Pod
  delegate_to: "{{ groups['masters'] | first }}"
  run_once: true
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
  - name: Create ServiceAccount for calico-busybox-test, configure RBAC, ClusterRole, ClusterRoleBinding, Apply PSP
    k8s:
      definition: "{{ lookup('file', item) }}"
      apply: yes
      state: "present"
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - busybox_serviceaccount.yaml
    - busybox-psp.yaml

  # Using a Deamonset ensures that a Pod is created on each node
  - name: Create the (calico-)BusyBox Daemonset
    k8s:
      definition: "{{ lookup('template', item) }}"
      apply: yes
      state: present
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - calico-busybox-daemonset.yaml.j2

  - name: Wait for (calico-)BusyBox Pods to get created
    command:
      argv:
        - kubectl
        - wait
        - -n
        - kube-system
        - -l
        - k8s-app=calico-busybox-test
        - --for=condition=Ready
        - pods
        - --timeout=60s

  - name: Collect (calico-)BusyBox Pod Resource Information
    k8s_info:
      kind: Pod
      label_selectors:
      - k8s-app=calico-busybox-test
    register: calico_busybox_pod_information

  # ping each Pod from each Pod with a nested loop
  - name: ping each BusyBox Pod from every BusyBox Pod
    command:
      argv:
        - kubectl
        - -n
        - kube-system
        - exec
        - --stdin
        - --tty
        - "{{ item[0].metadata.name }}"
        - --
        - ping
        - "{{ item[1].status.podIP }}"
        - -q
        - -c
        - 5
        - -w
        - 10
    with_nested:
      - "{{ calico_busybox_pod_information.resources }}"
      - "{{ calico_busybox_pod_information.resources }}"
    loop_control:
      label: "{{ item[0].metadata.name }} --> {{item[1].metadata.name }} ({{ item[1].status.podIP }})"

  # Using a Deamonset ensures that a Pod is created on each node
  - name: Delete the (calico-)BusyBox Daemonset
    k8s:
      definition: "{{ lookup('template', item) }}"
      apply: yes
      state: absent
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - calico-busybox-daemonset.yaml.j2

  - name: Delete ServiceAccount for calico-busybox-test, configure RBAC, ClusterRole, ClusterRoleBinding, Apply PSP
    k8s:
      definition: "{{ lookup('file', item) }}"
      apply: yes
      state: "absent"
      validate:
        fail_on_error: yes
        strict: yes
    with_items:
    - busybox_serviceaccount.yaml
    - busybox-psp.yaml
