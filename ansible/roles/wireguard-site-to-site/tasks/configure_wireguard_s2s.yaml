- name: Create wg-peer1.conf
  become: yes
  vars:
    password_store_dir: "{{ etc_dir }}/passwordstore"
  template:
    src: wg.conf.j2
    dest: /etc/wireguard/wg-peer1.conf
    owner: root
    group: root
    mode: 0640
  notify: Reconfigure wireguard

- name: Configure nftables
  become: yes
  vars:
    priv_ip_cidr: "{{ '%s/%s' | format(ansible_default_ipv4.address, ansible_default_ipv4.netmask) | ipaddr('network/prefix') }}"
  template:
    src: nftables.conf.j2
    dest: /etc/nft.d/20-site-to-site.conf
    owner: root
    group: root
    mode: 0640
  notify: Reconfigure nftables

- name: Configure bird
  become: yes
  template:
    src: bird.conf.j2
    dest: /etc/bird.d/20-wg-s2s.conf
    owner: bird
    group: bird
    mode: 0640
  notify: Reconfigure bird

- name: Configure keepalived
  become: yes
  copy:
    src: 10-wg-quick-notify.sh
    dest: /etc/keepalived/scripts
    owner: root
    group: root
    mode: "u=rwx,g=rw,o-rwx"
