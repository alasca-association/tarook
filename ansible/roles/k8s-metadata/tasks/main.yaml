---
- name: Set node labels
  become: no
  run_once: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  command:
  args:
    argv: "{{ ['kubectl', 'label', 'nodes', '--overwrite', item[0]] + item[1].k8s_node_labels | default([]) }}"
  loop: "{{ groups['workers'] | zip(groups['workers'] | map('extract', hostvars)) | list }}"
  when: "item[1].k8s_node_labels | default([])"
  loop_control:
    label: "node: {{ item[0] }}; labels: {{ item[1].k8s_node_labels | default([]) }}"
  tags:
  - k8s-metadata

- name: Set node taints
  become: no
  run_once: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  command:
  args:
    argv: "{{ ['kubectl', 'taint', 'nodes', '--overwrite', item[0]] + item[1].k8s_node_taints | default([]) }}"
  loop: "{{ groups['workers'] | zip(groups['workers'] | map('extract', hostvars)) | list }}"
  when: "item[1].k8s_node_taints | default([])"
  loop_control:
    label: "node: {{ item[0] }}; taints: {{ item[1].k8s_node_taints | default([]) }}"
  tags:
  - k8s-metadata
