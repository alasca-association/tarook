- name: Test if kubelet.conf exists
  become: yes
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_creds

- name: Test if the node exists already
  # using kubectl here as openshift et al. are otherwise not installed on worker nodes. seems kinda excessive to deploy it just to check whether we need to join.
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/kubelet.conf
  command:
  args:
    argv:
    - kubectl
    - get
    - node
    - "{{ inventory_hostname }}"
  failed_when: false
  changed_when: false
  when: kubelet_creds.stat.exists
  register: node_check

- name: Gather necessary cluster join information
  when: not kubelet_creds.stat.exists or node_check.rc != 0
  block:
  - name: Get certificate information
    become: no
    delegate_to: localhost
    community.crypto.x509_certificate_info:
      path: "{{ etc_dir }}/ca.crt"
    register: ca_cert

  - name: Join the k8s cluster steps
    become: yes
    block:
    - name: Create kubeadm-join-config.yaml
      vars:
        kubeadm_join_token: "{{ lookup('file', '{{ etc_dir }}/kubeadm_token') }}"
      template:
        src: kubeadm-join-config.yaml.j2
        dest: /tmp/kubeadm-join-config.yaml
        owner: root
        group: root
        mode: 0640

    - name: Join the k8s cluster as another worker
      # XXX: ansible command module does not support setting the umask
      shell: "umask 077 && kubeadm join --node-name {{ inventory_hostname | quote }} --config=/tmp/kubeadm-join-config.yaml"

    - name: Remove kubeadm-join-config.yaml
      file:
        path: /tmp/kubeadm-join-config.yaml
        state: absent

    # Workaround because it is currently not possible
    # to pass a kubelet config file for kubeadm join
    # https://stackoverflow.com/questions/60378117/limit-the-number-of-pods-per-node
    - name: Configure kubelet
      include_role:
        name: kubelet-configuration
      vars:
        _init_cluster: True # needs to be passed so that kubelet is configured & restarted
