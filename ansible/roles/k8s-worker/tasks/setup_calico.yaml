- name: Ensure that /etc/cni/net.d/ exists
  become: yes
  file:
    owner: root
    group: root
    mode: 0750
    path: /etc/cni/net.d/
    state: directory

- name: Ensure that /opt/cni/bin/ exists
  become: yes
  file:
    owner: root
    group: root
    mode: 0750
    recurse: yes
    path: /opt/cni/bin/
    state: directory

- name: Install calico
  become: yes
  get_url:
    owner: root
    group: root
    mode: 0755
    url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ calico.version }}/calico-amd64"
    dest: /opt/cni/bin/calico

- name: Install calico-ipam
  become: yes
  get_url:
    owner: root
    group: root
    mode: 0755
    url: "https://github.com/projectcalico/cni-plugin/releases/download/v{{ calico.version }}/calico-ipam-amd64"
    dest: /opt/cni/bin/calico-ipam

- name: Activate k8s Calico CNI plugin
  become: yes
  copy:
    owner: root
    group: root
    mode: 0600
    src: 10-calico.conflist
    dest: /etc/cni/net.d/10-calico.conflist

- name: Fetch calico-kubeconfig from the initial master to localhost
  become: yes
  copy:
    owner: root
    group: root
    mode: 0400
    src: "{{ etc_dir }}/calico-kubeconfig"
    dest: /etc/cni/net.d/calico-kubeconfig
