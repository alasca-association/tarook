- name: create user
  become: yes
  user:
    system: yes
    name: keepalived-exporter
    home: /dev/null
    create_home: no

- name: Install keepalived exporter
  vars:
    version: 0.3.0
    folder: "keepalived_exporter-{{ version }}-amd64"
  block:
    - name: Download keepalived_exporter
      become: no
      get_url:
        checksum: "sha256:df04a46c038ce4cc994ef5d1b77dc722b04589c8648a0d3382cacc57ef63824f"
        dest: /tmp
        url: "https://github.com/gen2brain/keepalived_exporter/releases/download/{{ version }}/{{ folder }}.tar.gz"
    - name: Extract binary
      become: no
      unarchive:
        src: "/tmp/{{ folder }}.tar.gz"
        dest: "/tmp/"
        remote_src: yes

    - name: Install binary to /usr/local/bin
      become: yes
      copy:
        src: "/tmp/{{ folder }}/keepalived_exporter"
        dest: /usr/local/bin
        owner: keepalived-exporter
        mode: u=rx,go-rwx
        remote_src: yes

    - name: Set capabilities
      become: yes
      capabilities:
        path: /usr/local/bin/keepalived_exporter
        capability: "{{ item }}"
        state: present
      with_items:
      - cap_dac_read_search+ep
      - cap_kill+ep
      - cap_net_admin+ep

- name: Create a systemd unit for keepalived_exporter
  become: yes
  copy:
    src: "{{ role_path }}/files/prometheus-keepalived-exporter.service"
    dest: /etc/systemd/system/

- name: Start & enable the systemd unit
  become: yes
  systemd:
    name: prometheus-keepalived-exporter
    state: restarted
    enabled: yes
    daemon-reload: yes
