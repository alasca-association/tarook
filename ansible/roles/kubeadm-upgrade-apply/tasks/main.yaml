- name: Run kubeadm upgrade plan
  become: yes
  command: kubeadm upgrade plan

# Do not renew certificates here because we rolled out our own chain
# --yes auto-confirms and makes upgrade non-interactive
- name: Execute the upgrade
  when: do_upgrade
  become: yes
  command: "kubeadm upgrade apply --certificate-renewal=false --yes v{{ next_k8s_version }}"
  # Let’s also play this safe here -- the `upgrade apply` command can take a
  # while and we want to be sure that we don’t run into any connection timeouts.
  # Note that this imposes a run-time limit on the apply command (half an hour)
  # which I suppose is OK.
  async: 1800
  poll: 5
