---
- name: show test information
  debug:
    msg: "This test is using the {{ block_storage_class }} storageClass"

- name: Run the test
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  block:
  - name: create namespace
    k8s:
      api_version: v1
      kind: Namespace
      name: "{{ check_block_storage_namespace }}"
      state: present
      validate:
        fail_on_error: yes
        strict: yes

  - name: create PVC
    k8s:
      definition: "{{ lookup('template', 'pvc.yaml') }}"
      state: present
      validate:
        fail_on_error: yes
        strict: yes

  - name: start writer pod
    k8s:
      definition: "{{ lookup('template', 'writer-pod.yaml') }}"
      state: present
      validate:
        fail_on_error: yes
        strict: yes

  - name: fetch writer pod completion state
    k8s_info:
      api_version: v1
      kind: Pod
      name: writer-test
      namespace: "{{ check_block_storage_namespace }}"
    register: writer_state
    until: "writer_state.resources and (writer_state.resources[0].status | default(False)) and (writer_state.resources[0].status.phase | default('') in ['Succeeded', 'Failed'])"
    delay: 5
    retries: 240

  - name: check writer pod success
    debug:
      msg: "Writer pod is in condition {{ writer_state.resources[0].status.phase }}"
    failed_when: 'writer_state.resources[0].status.phase == "Failed"'

  - name: run reader pod
    k8s:
      definition: "{{ lookup('template', 'reader-pod.yaml') }}"
      state: present
      validate:
        fail_on_error: yes
        strict: yes

  - name: fetch reader pod completion state
    k8s_info:
      api_version: v1
      kind: Pod
      name: reader-test
      namespace: "{{ check_block_storage_namespace }}"
    register: reader_state
    until: "reader_state.resources and (reader_state.resources[0].status | default(False)) and (reader_state.resources[0].status.phase | default('') in ['Succeeded', 'Failed'])"
    delay: 5
    retries: 240

  - name: check writer pod success
    debug:
      msg: "Reader pod is in condition {{ reader_state.resources[0].status.phase }}"
    failed_when: 'reader_state.resources[0].status.phase == "Failed"'

  - name: delete namespace
    k8s:
      api_version: v1
      kind: Namespace
      name: "{{ check_block_storage_namespace }}"
      state: absent
      wait: yes
      validate:
        fail_on_error: yes
        strict: yes
    tags:
    - test-cleanup
