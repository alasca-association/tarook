- name: Run the test
  become: no
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  block:
  - name: create namespace
    k8s:
      api_version: v1
      kind: Namespace
      state: present
      name: "{{ check_services_namespace }}"
      validate:
        fail_on_error: yes
        strict: yes

  - name: Apply the nginx+service manifest
    k8s:
      definition: "{{ lookup('template', 'nginx.yaml') }}"
      state: present
      wait: yes
      validate:
        fail_on_error: yes
        strict: yes

  - name: Check the connection
    vars:
      svc_test_port: 30060
    command: "curl -s {{ hostvars[gateway]['ansible_host'] }}:{{ svc_test_port }}"
    register: curl_result
    failed_when: curl_result.rc != 0

  - name: delete namespace
    k8s:
      api_version: v1
      kind: Namespace
      state: absent
      name: "{{ check_services_namespace }}"
      wait: yes
      validate:
        fail_on_error: yes
        strict: yes
    tags:
    - test-cleanup
