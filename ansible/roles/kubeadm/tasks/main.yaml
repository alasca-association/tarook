- name: Install prerequisites
  become: yes
  apt:
    update_cache: yes
    state: present
    name:
      - curl
      - apt-transport-https
  when: ansible_pkg_mgr == 'apt'

- name: Add Google's K8s repository (apt)
  become: yes
  block:

  - name: Add Key of Google's K8s repository
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

  - name: Add Google's K8s repository to sources.list
    copy:
      dest: /etc/apt/sources.list.d/kubernetes.list
      content: |
        deb https://apt.kubernetes.io/ kubernetes-xenial main

  - name: Install kubelet, kubeadm and kubectl
    # Note: check available version with `apt-cache policy <package name>`
    apt:
      update_cache: yes
  when: ansible_pkg_mgr == 'apt'

- name: Add Google's K8s repository (yum/dnf)
  become: yes
  copy:
    src: kubernetes.repo
    dest: /etc/yum.repos.d/kubernetes.repo
  when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'yum'

- name: Install kubelet, kubeadm and kubectl

  block:
  - name: Prepare list of packages to install (apt)
    set_fact:
      packages:
        - "kubelet={{ k8s_version }}-00"
        - "kubeadm={{ k8s_version }}-00"
        - "kubectl={{ k8s_version }}-00"
    when: ansible_pkg_mgr == 'apt'
    register: kubestuff_install_apt

  - name: Prepare list of packages to install (yum/dnf)
    set_fact:
      packages:
        - "kubelet-{{ k8s_version }}-00"
        - "kubeadm-{{ k8s_version }}-00"
        - "kubectl-{{ k8s_version }}-00"
    when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'yum'
    register: kubestuff_install_dnf

  - name: Install kubelet, kubeadm and kubectl
    # Note: check available version with `apt-cache policy <package name>`
    become: yes
    package:
      state: present
      name: "{{ packages }}"

  - name: Prevent the k8s packages for being updated (apt)
    become: yes
    command: apt-mark hold kubelet kubeadm kubectl
    when: ansible_pkg_mgr == 'apt'

  - name: Prevent the k8s packages for being updated (dnf)
    become: yes

    block:
    - name: Install dnf versionlock
      dnf:
        name:
        - 'dnf-command(versionlock)'
        state: latest

    - name: Add a version lock
      command:
      args:
        argv:
        - dnf
        - versionlock
        - kubelet
        - kubeadm
        - kubectl

    when: ansible_pkg_mgr == 'dnf'

- name: Configure kubelet
  become: yes
  # kubeadm apparently does not set --cloud-provider and --cloud-config correctly
  # in the cluster-wide ConfigMap. There is no need for us to create a drop-in
  # file because we can configure the environment by another file.
  # https://github.com/kubernetes/kubernetes/issues/36213
  copy:
    dest: /etc/default/kubelet
    content: |
      KUBELET_EXTRA_ARGS=--cloud-provider=external
  register: kubelet_configuration

- name: Restart kubelet
  become: yes
  systemd:
    state: restarted
    daemon_reload: yes
    name: kubelet
  when: kubestuff_install_apt is changed or kubestuff_install_dnf is changed or kubelet_configuration is changed
