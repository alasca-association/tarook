{{ _auto_generated_preamble }}

global
  log /dev/log local0 debug
  stats socket /tmp/haproxy_admin.sock mode 660 group haproxy level admin expose-fd listeners
  user haproxy
  group haproxy
  stats timeout 30s
  daemon

defaults
  log     global
  option log-health-checks
  timeout connect 5000
  timeout client  50000
  timeout server  50000

frontend k8s_front
  bind {{ private_vip }}:{{ k8s_apiserver_frontend_port }}
  mode tcp
  log global
  option tcplog
  timeout client {{ haproxy_timeout_client }}
  default_backend k8s_back

frontend healthz
  bind {{ haproxy_health_url }}
  mode http
  monitor-uri /healthz
  option dontlognull

backend k8s_back
  mode tcp
  option httpchk GET / "HTTP/1.1\r\nHost: 192.168.0.14\r\n\r\n"
  http-check expect status 403
  option redispatch
  log global
  balance roundrobin
  timeout connect 10s
  timeout server {{ haproxy_timeout_server }}

  {% for host in groups['masters'] %}
  server {{ host }} {{ hostvars[host]['local_ipv4_address'] }}:{{ k8s_apiserver_backend_port }} check check-ssl verify none
  {% endfor %}

{% for port in lb_ports %}
{% if port is mapping %}
{% set front_port = port.external %}
{% set back_port = port.nodeport %}
{% else %}
{% set front_port = port %}
{% set back_port = port %}
{% endif %}

frontend k8s-lb-frontend-{{ front_port }} # Autogenerated
  bind 0.0.0.0:{{ front_port }}
  mode tcp
  log global
  option tcplog
  timeout client {{ haproxy_timeout_client }}
  default_backend k8s-lb-backend-{{ back_port }}

backend k8s-lb-backend-{{ back_port }} # Autogenerated
  mode tcp
  option redispatch
  log global
  balance roundrobin
  timeout connect 10s
  timeout server {{ haproxy_timeout_server }}

  {% for host in groups['masters'] %}
  server {{ host }} {{ hostvars[host]['local_ipv4_address'] }}:{{ back_port }} verify none
  {% endfor %}

{% endfor %}

listen stats
  bind 0.0.0.0:{{ haproxy_stats_port }}
  mode http
  log global

  maxconn 2
  stats enable
  stats hide-version
  stats refresh 10s
  stats show-node
  stats auth admin:Eamo4uij
  stats uri /haproxy?stats
