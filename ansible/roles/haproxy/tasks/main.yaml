- name: Install HAProxy
  become: yes
  apt:
    update_cache: yes
    state: present
    name:
      - haproxy

- name: Register fact for private_vip
  set_fact:
    private_vip: "{{ networking_fixed_ip }}"

- name: Create HAProxy configuration
  become: yes
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    validate: haproxy -f %s -c
  register: haproxy

- name: Start the haproxy service
  become: yes
  systemd:
    daemon_reload: yes
    enabled: yes
    state: restarted
    name: haproxy
  when: haproxy is changed
