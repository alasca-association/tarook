- name: Prepare wireguard install on Debian
  become: yes
  when: 'ansible_distribution == "Debian"'

  block:
  - name: Pin packages from 'unstable' repo with low priority
    copy:
      dest: /etc/apt/preferences.d/limit-unstable
      content: |
        Package: *
        Pin: release a=unstable
        Pin-Priority: 90

  - name: Add 'unstable' repo to sources.list.d
    lineinfile:
      path: /etc/apt/sources.list.d/unstable.list
      create: yes
      state: present
      line: deb http://deb.debian.org/debian/ unstable main

  # This is an extra task because I'm not sure about the order packages are installed.
  # The header files must be available when DKMS wants to build the module
  - name: Install dependencies so wg dkms module is built
    become: yes
    apt:
      state: present
      update_cache: yes
      name:
        - linux-headers-cloud-amd64
        - bc

- name: Install wireguard
  become: yes
  apt:
    state: present
    name:
      - wireguard

- name: Modprobe the wireguard module to ensure its existence
  become: yes
  modprobe:
    name: wireguard
    state: present
