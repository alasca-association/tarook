- name: Detect user
  hosts: k8s_nodes
  gather_facts: false
  roles:
  - detect_user

- name: Check K8s setup
  hosts: k8s_nodes
  become: no
  gather_facts: false
  tasks:
    - name: Check that all hosts are initialized by the cloud provider # noqa no-changed-when risky-shell-pipe
      delegate_to: "{{ groups['masters'] | first }}"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      shell: "kubectl get nodes {{ inventory_hostname }} -o jsonpath='{.spec.taints[*].key}' | grep 'node.cloudprovider.kubernetes.io/uninitialized'"
      register: result
      failed_when: result.rc == 0
      tags:
      - test-ccm

    - name: Check that the Internal IP address of each node is set # noqa no-changed-when
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      delegate_to: "{{ groups['masters'] | first }}"
      command: "kubectl get nodes {{ inventory_hostname }} -o jsonpath='{.status.addresses[*].address}'"
      register: ip_address
      failed_when: ip_address.stdout == ""
      tags:
      - test-ccm

- name: Validate DualStack-Support
  hosts: k8s_nodes
  roles:
  - role: check-dualstack
    tags:
    - test-dualstack
    when: dualstack_support

- name: Test Calico CNI Support
  hosts: k8s_nodes
  gather_facts: no
  roles:
  - role: check-calico
    tags:
    - check-calico
    - test-dualstack
    when: k8s_network_plugin == 'calico'

# Ugly: assuming naming scheme here.
- name: Annotate worker nodes
  hosts: masters[0]
  become: no
  gather_facts: false
  tags:
    - label
  tasks:
    - name: Annotate the worker nodes # noqa no-changed-when
      # TODO: local delegation -> KUBECONFIG must be set correctly
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      command: "kubectl label --overwrite nodes {{ item['worker'] }} name={{ item['name'] }}"
      loop: "{{ test_worker_nodes }}"
      tags:
      - test-service
      - test-cinder-block-storage
      - test-ceph-block-storage
      - test-ceph-shared-filesystem

- name: Check services
  hosts: masters[0]
  become: no
  gather_facts: false
  vars:
    gateway: "{{ groups['gateways'] | first or groups['masters'] | first }}"
    deprecated_nodeport_lb_test_port: "{{ hostvars[groups['frontend'] | first ]['deprecated_nodeport_lb_test_port'] | default(0) }}"
  roles:
    - role: check-services
      when: "deprecated_nodeport_lb_test_port | int > 0"
      tags:
      - test-service
      - test-dualstack
    - role: check-loadbalancer-service
      tags:
      - test-loadbalancer-service
      - test-dualstack
      when: (openstack_lbaas | default(False)) or ch_k8s_lbaas_enabled

- name: Test enforcement of PodSecurityPolicies
  hosts: masters[0]
  become: no
  gather_facts: no
  roles:
  - role: check-psp-enforcement
    tags:
    - test-check-psp-enforcement
    when: "k8s_use_podsecuritypolicies"

- name: Test enforcement of NetworkPolicies
  hosts: masters[0]
  become: no
  gather_facts: no
  roles:
  - role: check-networkpolicy-enforcement
    tags:
    - test-networkpolicy-enforcement
    when: "k8s_network_plugin in ['kube-router', 'calico']"

# Same line for argumentation: especially rook is known to take a bit more time to boot up
- name: Check storage services
  hosts: masters[0]
  become: no
  gather_facts: false
  pre_tasks:
    # include default vars of rook
    - name: include rook defaults
      when: k8s_storage_rook_enabled | bool
      include_vars:
        file: "{{ ksl_playbook_directory }}/roles/rook_v1/defaults/main.yaml"
    - name: include ksl inventory variables
      when: ksl_vars_directory is defined
      include_vars:
        file: "{{ ksl_vars_directory }}/rook.yaml"
  vars:
    gateway: "{{ groups['gateways'] | first }}"
  roles:
    - role: check-block-storage
      tags: test-cinder-block-storage
      vars:
        block_storage_class: csi-sc-cinderplugin
    - role: check-block-storage
      tags: test-ceph-block-storage
      when: "k8s_storage_rook_enabled | bool"
      vars:
        block_storage_class: rook-ceph-data
    - role: check-shared-fs
      tags: test-ceph-shared-filesystem
      when: "(k8s_storage_rook_enabled | bool) and (rook_ceph_fs | bool)"
      vars:
        fs_storage_class: rook-ceph-cephfs
    - role: check-local-storage
      tags: test-local-storage
      storageclass: "{{ k8s_local_storage_static_storageclass_name | default('local-storage') }}"
      when: k8s_local_storage_static_enabled
    - role: check-local-storage
      tags: test-local-storage-dynamic
      storageclass: "{{ k8s_local_storage_dynamic_storageclass_name | default('local-storage') }}"
      when: k8s_local_storage_dynamic_enabled

- name: Remove worker node annotation
  hosts: masters[0]
  become: no
  gather_facts: false
  tasks:
      - name: Remove annotation of worker nodes # noqa no-changed-when
        environment:
          KUBECONFIG: /etc/kubernetes/admin.conf
        command: "kubectl label --overwrite nodes {{ item['worker'] }} name-"
        loop: "{{ test_worker_nodes }}"
        tags:
        - test-service
        - test-cinder-block-storage
        - test-ceph-block-storage
        - test-ceph-shared-filesystem
        - test-cleanup
