# IMPORTANT: this playbook is not fully automated because the upgrade procedure tends to change slightly. 
- name: Upgrade the first master node
  # TODO: do not hardcode, use jinja for master[0]
  hosts: master-az1
  tags:
    - first_master
  roles:
    - kubeadm-upgrade-info
    - kubeadm-upgrade-kubeadm
      # TODO: insert do_upgrade check flag here
    - kubeadm-drain-node
    - kubeadm-upgrade-apply
    - kubeadm-uncordon-node

- name: Upgrade the residual master nodes
  # TODO: do not hardcode, use jinja for master[1:]
  hosts:
    - master-az2
    - master-az3
  serial: 1
  tags:
    - residual_nodes
  roles:
    - kubeadm-upgrade-kubeadm
    - kubeadm-drain-node
    - kubeadm-upgrade-node
    - kubeadm-uncordon-node

- name: Upgrade kubelet on all nodes
  hosts: masters
  tags:
    - kubelet_masters
  # TODO: serialize!
  roles:
    - kubeadm-upgrade-kubelet

- name: Upgrade the worker nodes
  hosts: workers
  tags:
    - workers
  serial: 1
  roles:
    - kubeadm-upgrade-kubeadm
    # TODO: delegation does not work properly
    # workaround: execute kubectl drain / uncordon on localhost
    - kubeadm-drain-node
    - kubeadm-upgrade-node
    - kubeadm-upgrade-kubelet
    - kubeadm-uncordon-node
