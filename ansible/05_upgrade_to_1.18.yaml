- name: Detect user
  hosts: k8s_nodes
  gather_facts: false
  roles:
  - detect_user

- name: Run pre-flight checks on all nodes
  hosts: k8s_nodes
  gather_facts: true
  roles:
    - kubernetes-upgrade-info-1.18
  tags:
    - kubernetes-upgrade-preflight-checks

- name: Upgrade the first master node
  hosts: "{{ (groups['masters'] | sort)[0] }}"
  tags:
    - kubeadm-first-master
  roles:
    - kubeadm-upgrade-kubeadm
      # TODO: insert do_upgrade check flag here
    - kubeadm-drain-node
    - kubeadm-upgrade-apply
    - kubeadm-uncordon-node

- name: Upgrade the residual master nodes
  hosts: "{{ (groups['masters'] | sort)[1:] }}"
  serial: 1
  tags:
    - kubeadm-other-masters
  roles:
    - kubeadm-upgrade-kubeadm
    - kubeadm-drain-node
    - kubeadm-upgrade-node
    - kubeadm-uncordon-node

- name: Upgrade kubelet on master nodes
  hosts: masters
  tags:
    - kubelet-masters
  serial: 1
  roles:
    - kubeadm-upgrade-kubelet

- name: Upgrade the worker nodes
  hosts: workers
  tags:
    - workers
  serial: 1
  roles:
    - kubeadm-upgrade-kubeadm
    # TODO: delegation does not work properly
    # workaround: execute kubectl drain / uncordon on localhost
    - kubeadm-drain-node
    - kubeadm-upgrade-node
    - kubeadm-upgrade-kubelet
    - kubeadm-uncordon-node
